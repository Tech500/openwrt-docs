<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>The OpenWrt Flash Layout [OpenWrt Wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="doc,techref,flash.layout"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="OpenWrt Wiki"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="flash.layout?do=index" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Recent changes" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="../../feed.php?mode=list&amp;ns=doc:techref"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/doc/techref/flash.layout"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../../_export/raw/doc/techref/flash.layout"/>
<link rel="canonical" href="flash.layout"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php?t=openwrt&amp;tseed=6f44f363dc87908d905dc56ff3acbfc4"/>
<script type="text/javascript">/*<![CDATA[*/var NS='doc:techref';var JSINFO = {"id":"doc:techref:flash.layout","namespace":"doc:techref"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php?tseed=6f44f363dc87908d905dc56ff3acbfc4"></script>
<script type="text/javascript" charset="utf-8">/*<![CDATA[*/jQuery(function(){
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1432265491 166.182.3.232';
			document.forms[i].appendChild(myElement);
		}
	}
});
/*!]]>*/</script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../lib/tpl/openwrt/images/favicon.ico" />
<link rel="apple-touch-icon" href="../../lib/tpl/openwrt/images/apple-touch-icon.png" />
    </head>

<body>
    <!--[if lte IE 7 ]><div id="IE7"><![endif]--><!--[if IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_openwrt     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="flash.layout#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="../../start"  accesskey="h" title="[H]"><img src="../../lib/tpl/openwrt/images/logo.png" width="386" height="98" alt="" /> <span>OpenWrt Wiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="flash.layout?do=register"  class="action register" rel="nofollow" title="Register">Register</a></li><li><a href="flash.layout?do=login&amp;sectok=382740b13d95f946eed36caa57076b4a"  class="action login" rel="nofollow" title="Login">Login</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="../../start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="../../doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="doc:techref:flash.layout" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Login</option><option value="register">Register</option></optgroup></select><input type="submit" value="&gt;" /></div></form>            </div>
            <ul>
                <li><a href="flash.layout?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Recent changes [R]">Recent changes</a></li><li><a href="flash.layout?do=media&amp;ns=doc%253Atechref"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="flash.layout?do=index"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="../../start" class="wikilink1" title="start">OpenWrt Wiki</a></bdi></span> » <bdi><a href="../start" class="wikilink1" title="doc:start">Documentation</a></bdi> » <bdi><a href="../techref.1" class="wikilink1" title="doc:techref:start">Technical Reference</a></bdi> » <bdi><span class="curid"><a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">The OpenWrt Flash Layout</a></span></bdi></div>
                                    <div class="plugin_multilingual">
        <ul>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/cz/doc/techref/flash.layout" class="media" title="cz:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=aff589&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fcz.gif" class="media" title="Čeština (Czech)" alt="Čeština (Czech)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/de/doc/techref/flash.layout" class="media" title="de:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=e24010&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fde.gif" class="media" title="Deutsch (German)" alt="Deutsch (German)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <span class="curid"><a href="flash.layout" class="media" title="doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=2a37ae&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fgb.gif" class="media" title="English" alt="English" /></a></span>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/es/doc/techref/flash.layout" class="media" title="es:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=46c004&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fmx.gif" class="media" title="Español (Spanish, Mexico)" alt="Español (Spanish, Mexico)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../fr/doc/techref/flash.layout" class="media" title="fr:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=a5beba&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ffr.gif" class="media" title="Français (French)" alt="Français (French)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/hu/doc/techref/flash.layout" class="media" title="hu:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=6b5470&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fhu.gif" class="media" title="Magyar (Hungarian)" alt="Magyar (Hungarian)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/jp/doc/techref/flash.layout" class="media" title="jp:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f999fc&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fjp.gif" class="media" title="日本語 (Japanese)" alt="日本語 (Japanese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pl/doc/techref/flash.layout" class="media" title="pl:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=c805c0&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fpl.gif" class="media" title="Poliski (Polish)" alt="Poliski (Polish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pt-br/doc/techref/flash.layout" class="media" title="pt-br:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=13127d&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fbr.gif" class="media" title="Português brasileiro (Portuguese, Brasil)" alt="Português brasileiro (Portuguese, Brasil)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../ru/doc/techref/flash.layout" class="media" title="ru:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=66ab5e&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fru.gif" class="media" title="Русский (Russsian)" alt="Русский (Russsian)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/tr/doc/techref/flash.layout" class="media" title="tr:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f4beed&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ftr.gif" class="media" title="Tϋrkçe (Turkish)" alt="Tϋrkçe (Turkish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../zh-cn/doc/techref/flash.layout" class="media" title="zh-cn:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=93625a&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-cn.gif" class="media" title="官話/官话 (Chinese)" alt="官話/官话 (Chinese)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-tw/doc/techref/flash.layout" class="media" title="zh-tw:doc:techref:flash.layout"><img src="../../lib/exe/fetch.php?cache=&amp;tok=b56198&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-tw.gif" class="media" title="臺灣華語 (Taiwanese)" alt="臺灣華語 (Taiwanese)" /></a>
              </div>
            </div>
          </li>
        </ul>
      </div>
        </div>
    
    
    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">

                <div class="pageId"><span>doc:techref:flash.layout</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="flash.layout#partitioning_of_squashfs-images">Partitioning of SquashFS-Images</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="flash.layout#partitions">Partitions</a></div></li>
<li class="level2"><div class="li"><a href="flash.layout#filesystems">Filesystems</a></div></li>
<li class="level2"><div class="li"><a href="flash.layout#mount_points">Mount Points</a></div></li>
<li class="level2"><div class="li"><a href="flash.layout#directory_structurefilesystem_hierarchy">Directory Structure / Filesystem Hierarchy</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="flash.layout#partitioning_of_jffs2-images">Partitioning of JFFS2-Images</a></div></li>
<li class="level1"><div class="li"><a href="flash.layout#discovery_how_to_find_out">Discovery (How to find out)</a></div></li>
<li class="level1"><div class="li"><a href="flash.layout#details">Details</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="flash.layout#generic">generic</a></div></li>
<li class="level2"><div class="li"><a href="flash.layout#broadcom_with_cfe">broadcom with CFE</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="flash.layout#explanations">Explanations</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="flash.layout#what_is_an_image_file">What is an Image File?</a></div></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="the_openwrt_flash_layout">The OpenWrt Flash Layout</h1>
<div class="level1">

<p>
Most routers do not have hard drives.  They use flash memory for similar purposes: storing programs and data, even when the system is off (non-volatile memory).
</p>

<p>
In most systems, flash memory does not appear like RAM and so data and instructions must be copied to RAM to be used.  So, for example, the bootloader copies the kernel from flash to RAM and then starts that copy running.
</p>

<p>
There are two basic types of flash memory: <a href="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash">NOR flash</a> and <a href="http://en.wikipedia.org/wiki/Flash_memory#NAND_flash" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Flash_memory#NAND_flash">NAND flash</a>.<br/>

If the flash chip (no matter what type) is connected directly with the <a href="http://en.wikipedia.org/wiki/System-on-a-chip" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/System-on-a-chip">SoC</a> and has to be addressed directly by Linux, we call it <strong><em>&quot;raw flash&quot;</em></strong>.
If there is an additional controller chip between flash chip and the SoC, we call it <strong><em>&quot;FTL (Flash Translation Layer) flash&quot;</em></strong>. Embedded systems almost exclusively use &quot;raw flash&quot;, while SSDs and also USB memory sticks, almost exclusively use FTL flash!
</p>

<p>
Older routers generally have raw NOR flash but many newer routers have raw NAND flash.
</p>

<p>
Raw NOR flash in typical routers is generally small (4 MiB - 16 MiB) and error-free.  This is currently the normal OpenWRT setup.  Because it is error-free, the file systems are a little simpler.  But they still need to do wear-levelling.  Conserving space is important.
</p>

<p>
Raw NAND flash in typical routers is generally larger (32 MiB - 256 MiB) and may contain bad blocks.  OpenWRT isn&#039;t configured to handle this yet.  One promising approach would be to use <a href="https://en.wikipedia.org/wiki/UBIFS" class="urlextern" title="https://en.wikipedia.org/wiki/UBIFS"  rel="nofollow">UBIFS</a> layered on top of UBI.
</p>

</div>

<h2 class="sectionedit2" id="partitioning_of_squashfs-images">Partitioning of SquashFS-Images</h2>
<div class="level2">

<p>
Almost all embedded systems contain <em>&quot;raw flash&quot;</em>-chips. OpenWrt treats and addresses this storage space as an <a href="mtd" class="wikilink1" title="doc:techref:mtd"> MTD (Memory Technology Device)</a> and employs <a href="filesystems" class="wikilink1" title="doc:techref:filesystems">filesystems</a> developed for this purpose. The available storage is not partitioned in the traditional way, where you store the data about the partitions in the <a href="http://en.wikipedia.org/wiki/Master boot record" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Master boot record">MBR</a> and <a href="http://en.wikipedia.org/wiki/Volume boot record" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Volume boot record">PBR</a>s, but it is done in the Linux Kernel (and sometimes independently in the <a href="bootloader.1" class="wikilink1" title="doc:techref:bootloader">bootloader</a> as well!). You simply define, that &quot;partition <strong><em>kernel</em></strong> starts at offset x and ends at offset y&quot;. The advantage is, that later we can address these partitions by name, rather then specifying the precise start point of the data.
</p>

<p>
<img src="../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> The following table gives you a visual of the layout of the <a href="../../toh/tp-link/tl-wr1043nd" class="wikilink1" title="toh:tp-link:tl-wr1043nd">TL-WR1043ND</a> and is merely one <strong>example</strong>! Another, slightly different, example can be found on the wiki-page for the <a href="../../toh/d-link/dir-300#flashlayout" class="wikilink1" title="toh:d-link:dir-300">DIR-300</a>. So the layout does differ between the devices! Please see the wiki-page for a device, for information about its particular layout and simply check it yourself on your device.
</p>
<div class="table sectionedit3"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 centeralign" colspan="6">   TP-Link WR1043ND  Flash Layout           </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0 leftalign"> Layer0       </th><td class="col1 centeralign" colspan="5">                       m25p80 <a href="http://en.wikipedia.org/wiki/Serial Peripheral Interface Bus" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Serial Peripheral Interface Bus">spi</a>0.0: m25p64      8192KiB                                                                      </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign"> Layer1       </th><td class="col1 centeralign">  mtd0 <strong><em>u-boot</em></strong> 128KiB  </td><td class="col2 centeralign" colspan="3">  mtd5 <strong><em>firmware</em></strong> 8000KiB                                      </td><td class="col5 centeralign">    mtd4 <strong><em>art</em></strong> 64KiB  </td>
	</tr>
	<tr class="row3">
		<th class="col0 leftalign"> Layer2       </th><td class="col1 leftalign">                              </td><td class="col2 centeralign">  mtd1 <strong><em>kernel</em></strong> 1280KiB  </td><td class="col3 centeralign" colspan="2">  mtd2 <strong><em>rootfs</em></strong> 6720KiB                           </td><td class="col5 leftalign">          </td>
	</tr>
	<tr class="row4">
		<th class="col0 leftalign"> <span style='color:magenta; '>mountpoint</span>   </th><td class="col1 leftalign">                              </td><td class="col2 leftalign">                               </td><td class="col3 centeralign" colspan="2">  <span style='color:magenta; '><code>/</code></span>                          </td><td class="col5 leftalign">          </td>
	</tr>
	<tr class="row5">
		<th class="col0 leftalign"> filesystem   </th><td class="col1 leftalign">                              </td><td class="col2 leftalign">                               </td><td class="col3 centeralign" colspan="2">  <a href="filesystems#mini_fo" class="wikilink1" title="doc:techref:filesystems">mini_fo</a>/<a href="filesystems#overlayfs" class="wikilink1" title="doc:techref:filesystems">overlayfs</a>           </td><td class="col5 leftalign">          </td>
	</tr>
	<tr class="row6">
		<th class="col0 leftalign"> Layer3       </th><td class="col1 leftalign">                              </td><td class="col2 leftalign">                               </td><td class="col3 leftalign">                 </td><td class="col4 centeralign">  mtd3 <strong><em>rootfs_data</em></strong> 5184KiB     </td><td class="col5 leftalign">          </td>
	</tr>
	<tr class="row7">
		<th class="col0 leftalign"> Size in KiB  </th><td class="col1 centeralign">  128KiB                      </td><td class="col2 centeralign">  1280KiB                      </td><td class="col3 centeralign">  1536KiB        </td><td class="col4 centeralign">  5184KiB                              </td><td class="col5 centeralign">   64KiB  </td>
	</tr>
	<tr class="row8">
		<th class="col0 leftalign"> Name         </th><td class="col1 centeralign">  <strong><em>u-boot</em></strong>              </td><td class="col2 centeralign">  <strong><em>kernel</em></strong>               </td><td class="col3 leftalign">                 </td><td class="col4 centeralign">  <strong><em>rootfs_data</em></strong>             </td><td class="col5 centeralign">  <strong><em>art</em></strong>  </td>
	</tr>
	<tr class="row9">
		<th class="col0 leftalign"> <span style='color:magenta; '>mountpoint</span>   </th><td class="col1 centeralign">  <em>none</em>                    </td><td class="col2 centeralign">  <em>none</em>                     </td><td class="col3 centeralign">  <span style='color:magenta; '><code>/rom</code></span>  </td><td class="col4 centeralign">  <span style='color:magenta; '><code>/overlay</code></span>   </td><td class="col5 centeralign">  <em>none</em>  </td>
	</tr>
	<tr class="row10">
		<th class="col0 leftalign"> filesystem   </th><td class="col1 centeralign">  <em>none</em>                    </td><td class="col2 centeralign">  <em>none</em>                     </td><td class="col3 centeralign">  <a href="filesystems#squashfs" class="wikilink1" title="doc:techref:filesystems">SquashFS</a>  </td><td class="col4 centeralign">  <a href="filesystems#jffs2" class="wikilink1" title="doc:techref:filesystems">JFFS2</a>  </td><td class="col5 centeralign">  <em>none</em>  </td>
	</tr>
</table></div>

<p>
Here is a LibreOffice Calc ODS for better understanding: <a href="https://web.archive.org/web/20131021013058/http://ubuntuone.com/2aPBH9pwkxtYzy93S0cS1z" class="urlextern" title="https://web.archive.org/web/20131021013058/http://ubuntuone.com/2aPBH9pwkxtYzy93S0cS1z"  rel="nofollow">https://web.archive.org/web/20131021013058/http://ubuntuone.com/2aPBH9pwkxtYzy93S0cS1z</a>.
</p>

</div>

<h3 class="sectionedit4" id="partitions">Partitions</h3>
<div class="level3">

<p>
Since the partitions are nested we look at this whole thing in layers:
</p>
<ol>
<li class="level1"><div class="li"> Layer0: So we have the Flashchip, 8MiB in size, which is soldered to the PCB and connected to the <a href="../hardware/soc.1" class="wikilink1" title="doc:hardware:soc">SoC</a> over <a href="http://en.wikipedia.org/wiki/Serial Peripheral Interface Bus" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Serial Peripheral Interface Bus">SPI (Serial Peripheral Interface Bus)</a>.</div>
</li>
<li class="level1"><div class="li"> Layer1: We &quot;partition&quot; the space into mtd0 for the bootloader, mtd5 for the firmware and, in this case, mtd4 for the ART (Atheros Radio Test) - it contains calibration data for the wifi (EEPROM). If it is missing or corrupt, <code>ath9k</code> (wireless driver) won&#039;t come up anymore. The bootloader (128k ) contains of the u-boot 64k block AND a data section which contains the MAC,WPS-PIN and type description. If no mac is configured wifi will not work correctly due to a faulty MAC.</div>
</li>
<li class="level1"><div class="li"> Layer2: we subdivide mtd5 (firmware) into mtd1 (kernel) and mtd2 (rootfs); In the generation process of the firmware (see <a href="../howto/imagegenerator" class="wikilink1" title="doc:howto:obtain.firmware.generate">obtain.firmware.generate</a>) the Kernel binary file is first packed with <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a>, then the obtained file is packed with <a href="http://en.wikipedia.org/wiki/gzip" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/gzip">gzip</a> and then this file will be written onto the raw flash (mtd1) without being part of any filesystem!</div>
</li>
<li class="level1"><div class="li"> Layer3: we subdivide rootfs even further into mtd3 for rootfs_data and the rest for an unnamed partition which will accommodate the SquashFS-partition.</div>
</li>
</ol>

</div>

<h3 class="sectionedit5" id="filesystems">Filesystems</h3>
<div class="level3">

<p>
→ <a href="filesystems" class="wikilink1" title="doc:techref:filesystems">filesystems</a>
</p>

</div>

<h3 class="sectionedit6" id="mount_points">Mount Points</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> <span style='color:magenta; '><code>/</code></span> this is your entire root filesystem, it comprises <code>/rom</code> and <code>/overlay</code>. Please ignore <code>/rom</code> and <code>/overlay</code> and use exclusively <code>/</code> for your daily routines!</div>
</li>
<li class="level1"><div class="li"> <span style='color:magenta; '><code>/rom</code></span>  contains all the basic files, like <code>busybox</code>, <code>dropbear</code> or <code>iptables</code>. It also includes default configuration files used when booting into <a href="../howto/generic.failsafe" class="wikilink1" title="doc:howto:generic.failsafe">OpenWrt Failsafe mode</a>. It does not contain the Linux kernel. All files in this directory are located on the SqashFS partition, and thus cannot be altered or deleted. But, because we use overlay_fs filesystem, so called <em>overlay-whiteout</em>-symlinks can be created on the JFFS2 partition.</div>
</li>
<li class="level1"><div class="li"> <span style='color:magenta; '><code>/overlay</code></span>  is the writable part of the file system that gets merged with <code>/rom</code> to create a uniform <code>/</code>-tree. It contains anything that was written to the router after <a href="../howto/installing" class="wikilink1" title="doc:howto:generic.flashing">installation</a>, e.g. changed configuration files, additional packages installed with <code><a href="opkg" class="wikilink1" title="doc:techref:opkg">opkg</a></code>, etc. It is formated with JFFS2.</div>
</li>
</ul>

<p>
Whenever the system is asked to look for an existing file in <code>/</code>, it first looks in <code>/overlay</code>, and if not there, then in <code>/rom</code>.  In this way <code>/overlay</code> overrides <code>/rom</code> and creates the effect of a writable <code>/</code> while much of the content is safely and efficiently stored in the read-only <code>/rom</code>.
</p>

<p>
When the system is asked to delete a file that is in <code>/rom</code>, it instead creates a corresponding entry in <code>/overlay</code>, a whiteout.  A whiteout is a symlink to <code>(overlay-whiteout)</code> that mostly behaves like a file that doesn&#039;t exist.
</p>

<p>
<pre class="code bash"><span class="co0">#!/bin/sh</span>
<span class="co0"># shows all overlay-whiteout symlinks</span>
&nbsp;
<span class="kw2">find</span> <span class="sy0">/</span>overlay <span class="re5">-type</span> l <span class="re5">-exec</span> <span class="kw2">sh</span> <span class="re5">-c</span> \
    <span class="st_h">'for x; do [ &quot;$(readlink -n -- &quot;$x&quot;)&quot; = &quot;(overlay-whiteout)&quot; ] &amp;&amp; printf %s\\n &quot;$x&quot;; done'</span> <span class="re5">--</span> <span class="br0">&#123;</span><span class="br0">&#125;</span> +</pre>

</p>

</div>

<h3 class="sectionedit7" id="directory_structurefilesystem_hierarchy">Directory Structure / Filesystem Hierarchy</h3>
<div class="level3">

<p>
<strong><em><code>NOTE1</code></em>:</strong> If the Kernel was part of the SquashFS, we could NOT control where exactly on the flash the kernel is written (namely, on which blocks the data is written to). Thus we can not tell the bootloader to simply load and execute certain blocks on the flash storage. Now this would not be too bad, but in order for that to happen the bootloader would have to understand the SquashFS filesystem; which it does not. The embedded bootloaders we utilize with OpenWrt generally has no concept of filesystems, and thus they cannot address files by path and filename. The bootloaders pretty much assume that the start of the trx data section is executable code.<br/>

<strong><em><code>NOTE2</code></em>:</strong>  Generally,the term <code>&quot;firmware&quot;</code> is used for the all data stored on the flash -comprising the boot loader and any other data necessary to operate the device (such as ART, NVRAM, FIS, etc), but it is also use to name only the parts that are being rewritten. Don&#039;t let this confuse you <img src="../../lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" /><br/>

</p>

</div>

<h2 class="sectionedit8" id="partitioning_of_jffs2-images">Partitioning of JFFS2-Images</h2>
<div class="level2">

<p>
TODO
</p>

</div>

<h2 class="sectionedit9" id="discovery_how_to_find_out">Discovery (How to find out)</h2>
<div class="level2">

<p>
<pre class="code">cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00020000 00010000 &quot;u-boot&quot;
mtd1: 00140000 00010000 &quot;kernel&quot;
mtd2: 00690000 00010000 &quot;rootfs&quot;
mtd3: 00530000 00010000 &quot;rootfs_data&quot;
mtd4: 00010000 00010000 &quot;art&quot;
mtd5: 007d0000 00010000 &quot;firmware&quot;</pre>

</p>

<p>
The <em>erasesize</em> is the <a href="http://en.wikipedia.org/wiki/Block (data storage)" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Block (data storage)">block size</a> of the flash, in this case 64KiB. The <em>size</em> is little or big <a href="http://en.wikipedia.org/wiki/Endianess" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Endianess">endian</a> hex value in Bytes. In case of little endian, you switch to hex-mode and enter 02 0000 into the <a href="http://www.acalculator.com/calculators.html" class="urlextern" title="http://www.acalculator.com/calculators.html"  rel="nofollow"> calculator</a> for example and convert to decimal (by switching back to decimal mode again). Then guess how they are nested into each other. Or execute <code>dmesg</code> after a fresh boot and look for something like:
</p>

<p>
<pre class="code">Creating 5 MTD partitions on &quot;spi0.0&quot;:
0x000000000000-0x000000020000 : &quot;u-boot&quot;
0x000000020000-0x000000160000 : &quot;kernel&quot;
0x000000160000-0x0000007f0000 : &quot;rootfs&quot;
mtd: partition &quot;rootfs&quot; set to be root filesystem
mtd: partition &quot;rootfs_data&quot; created automatically, ofs=2C0000, len=530000
0x0000002c0000-0x0000007f0000 : &quot;rootfs_data&quot;
0x0000007f0000-0x000000800000 : &quot;art&quot;
0x000000020000-0x0000007f0000 : &quot;firmware&quot;</pre>

These are the start and end offsets of the partitions as hex values in Bytes. Now you don&#039;t have to guess which is nested in which. E.g. 02 0000 = 131.072 Bytes = 128KiB.
</p>

</div>

<h2 class="sectionedit10" id="details">Details</h2>
<div class="level2">

</div>

<h3 class="sectionedit11" id="generic">generic</h3>
<div class="level3">

<p>
The flash chip can be represented as a large block of continuous space:
</p>
<div class="table sectionedit12"><table class="inline">
	<tr class="row0">
		<td class="col0 leftalign"> start of flash …………….. end of flash  </td>
	</tr>
</table></div>

<p>
There is no ROM to boot from; at power up the CPU begins executing the code at the very start of the flash. Luckily this isn&#039;t the firmware or we&#039;d be in real danger every time we reflashed. Boot is actually handled by a section of code we tend to refer to as the <a href="bootloader.1" class="wikilink1" title="doc:techref:bootloader">bootloader</a> (the BIOS of your PC <em>is</em> a bootloader).
</p>
<div class="table sectionedit13"><table class="inline">
	<thead>
	<tr class="row0">
		<td class="col0"> </td><th class="col1"> Boot Loader Partition </th><th class="col2"> Firmware Partition </th><th class="col3" colspan="3"> <code>Special Configuration Data</code> </th>
	</tr>
	</thead>
	<tr class="row1">
		<th class="col0 leftalign"> Atheros  </th><td class="col1 centeralign">  <a href="bootloader/uboot" class="wikilink1" title="doc:techref:bootloader:uboot">U-Boot</a>   </td><td class="col2 centeralign">  firmware  </td><td class="col3 centeralign" colspan="3">  <code>ART</code>         </td>
	</tr>
	<tr class="row2">
		<th class="col0"> Broadcom </th><td class="col1 centeralign">  CFE      </td><td class="col2 centeralign">  firmware  </td><td class="col3 centeralign" colspan="3">  <code>NVRAM</code>       </td>
	</tr>
	<tr class="row3">
		<th class="col0 leftalign"> Atheros  </th><td class="col1 centeralign">  RedBoot  </td><td class="col2 centeralign">  firmware  </td><td class="col3 centeralign">  <code>FIS recovery</code>  </td><td class="col4 centeralign">  <code>RedBoot config</code>  </td><td class="col5 centeralign">  <code>boardconfig</code>  </td>
	</tr>
</table></div>

<p>
The partition or partitions containing so called <em>Special Configuration Data</em> differ very much from each other. Example: The <code>ART</code>-partition you will meet in conjunction with Atheros-Wireless and U-Boot, contains only data regarding the wireless driver, while the <code>NVRAM</code>-partition of broadcom devices is used for much more than only that. There are special utilities to access and modify special configuration partitions. For Broadcom devices this is the <code>nvram</code> utility. To find out what is written in <code>NVRAM</code> you can run <code>nvram show</code>.
</p>

<p>
Note that clearing these special configuration data partitions like <code>ART, NVRAM</code> and <code>FIS</code> does not clear much of OpenWrt&#039;s configuration, unlike other router software which keep configuration data solely in e.g. <code>NVRAM</code>. Instead, as a consequence of using the overlay_fs filesystem configuration with JFFS2 flash partition, the whole file system is writable and allows the flexibility of extending your OpenWrt installation in any way you want. OpenWrt&#039;s main configuration is therefore just kept in the root file system, using <a href="../uci.1" class="wikilink1" title="doc:uci">UCI</a> configuration files. For convenience, many other packages are made UCI compatible. If you want to reset your complete installation you should use OpenWrt&#039;s built-in functionality such as <a href="../howto/generic.sysupgrade" class="wikilink1" title="doc:howto:generic.sysupgrade">sysupgrade</a> to restore settings, by clearing the JFFS2 partition. Or, if you cannot boot normally, you can wipe or change the JFFS2 partition using OpenWrt&#039;s <a href="../howto/generic.failsafe" class="wikilink1" title="doc:howto:generic.failsafe">failsafe mode</a> (look in your device&#039;s dedicated page for information how to boot into failsafe). 
</p>

</div>

<h3 class="sectionedit14" id="broadcom_with_cfe">broadcom with CFE</h3>
<div class="level3">

<p>
If you dig into the &quot;firmware&quot; section you&#039;ll find a trx. A trx is just an encapsulation, which looks something like this:
</p>
<div class="table sectionedit15"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0" colspan="7"> trx-header </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> HDR0  </td><td class="col1 centeralign">  length  </td><td class="col2 centeralign">  crc32  </td><td class="col3 centeralign">  flags  </td><td class="col4 centeralign">  pointers  </td><td class="col5 centeralign">  data  </td><td class="col6"></td>
	</tr>
</table></div>

<p>
&quot;HDR0&quot; is a magic value to indicate a trx header, rest is 4 byte unsigned values followed by the actual contents. In short, it&#039;s a block of data with a length and a checksum. So, our flash usage actually looks something like this:
</p>
<div class="table sectionedit16"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  CFE  </td><td class="col1 centeralign">  trx containing firmware  </td><td class="col2 centeralign">  NVRAM  </td>
	</tr>
</table></div>

<p>
Except that the firmware is generally pretty small and doesn&#039;t use the entire space between CFE and NVRAM:
</p>
<div class="table sectionedit17"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  CFE  </td><td class="col1 centeralign">  trx firmware  </td><td class="col2 centeralign">  unused  </td><td class="col3 centeralign">  NVRAM  </td>
	</tr>
</table></div>

<p>
(<strong><em><code>NOTE</code></em>:</strong> The &lt;model&gt;.bin files are nothing more than the generic *.trx file with an additional header appended to the start to identify the model. The model information gets verified by the vendor&#039;s upgrade utilities and only the remaining data – the trx – gets written to the flash. When upgrading from within OpenWrt remember to use the *.trx file.)
</p>

<p>
So what exactly is the firmware?
</p>

<p>
The boot loader really has no concept of filesystems, it pretty much assumes that the start of the trx data section is executable code. So, at the very start of our firmware is the kernel. But just putting a kernel directly onto flash is quite boring and consumes a lot of space, so we compress the kernel with a heavy compression known as <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a>. Now the start of firmware is code for an LZMA decompress:
</p>
<div class="table sectionedit18"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  lzma decompress  </td><td class="col1 centeralign">  lzma compressed kernel  </td>
	</tr>
</table></div>

<p>
Now, the boot loader boots into an LZMA program which decompresses the kernel into RAM and executes it. It adds one second to the bootup time, but it saves a large chunk of flash space. (And if that wasn&#039;t amusing enough, it turns out the boot loader does know gzip compression, so we gzip compressed the LZMA decompression program)
</p>

<p>
Immediately following the kernel is the filesystem. We use SquashFS for this because it&#039;s a highly compressed readonly filesystem – remember that altering the contents of the trx in any way would invalidate the crc, so we put our writable data in a JFFS2 partition, which is outside the trx. This means that our firmware looks like this:
</p>
<div class="table sectionedit19"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  trx  </td><td class="col1 leftalign"> gzip&#039;d lzma decompress  </td><td class="col2 centeralign">  lzma&#039;d kernel  </td><td class="col3 centeralign">  (SquashFS filesystem)  </td>
	</tr>
</table></div>

<p>
And the entire flash usage looks like this -
</p>
<div class="table sectionedit20"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  CFE  </td><td class="col1 centeralign">  trx  </td><td class="col2 centeralign">  gz&#039;d lzma  </td><td class="col3 centeralign">  lzma&#039;d kernel  </td><td class="col4 centeralign">  SquashFS  </td><td class="col5 centeralign">  JFFS2 filesystem  </td><td class="col6 centeralign">  NVRAM  </td>
	</tr>
</table></div>

<p>
That&#039;s about as tight as we can possibly pack things into flash.
</p>
<hr />

</div>

<h2 class="sectionedit21" id="explanations">Explanations</h2>
<div class="level2">

</div>

<h3 class="sectionedit22" id="what_is_an_image_file">What is an Image File?</h3>
<div class="level3">

<p>
An image file is byte by byte copy of data contained in a file system. If you installed a Debian or a Windows in the usual way onto one or two hard disk partitions and would afterwards copy the whole content byte by byte from the hard disk into one file:
</p>

<p>
<pre class="code bash"><span class="kw2">dd</span> <span class="re2">if</span>=<span class="sy0">/</span>dev<span class="sy0">/</span>sda <span class="re2">of</span>=<span class="sy0">/</span>media<span class="sy0">/</span>sdb3<span class="sy0">/</span>backup.dd</pre>

</p>

<p>
the obtained backup file <code>/media/sdb3/backup.dd</code>, could be used in the exact same manner like an OpenWrt-Image-File.
</p>

<p>
The difference is, that OpenWrt-Image-File are not created that way <img src="../../lib/images/smileys/icon_wink.gif" class="icon" alt=";-)" /> They are being generated with the <strong>Image Generator</strong> (former called Image Builder). You can read about the:
</p>
<ul>
<li class="level1"><div class="li"> <span class="curid"><a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">flash.layout</a></span></div>
</li>
<li class="level1"><div class="li"> <a href="header" class="wikilink1" title="doc:techref:header">header</a></div>
</li>
<li class="level1"><div class="li"> <a href="../howto/imagegenerator" class="wikilink1" title="doc:howto:obtain.firmware.generate">obtain.firmware.generate</a> If you want to read about the <strong>Image Generator</strong>, go back to <a href="../howto/obtain.firmware" class="wikilink1" title="doc:howto:obtain.firmware">obtain.firmware</a> and choose the second way.</div>
</li>
<li class="level1"><div class="li"> About <a href="http://skaya.enix.org/wiki/FirmwareFormat" class="urlextern" title="http://skaya.enix.org/wiki/FirmwareFormat"  rel="nofollow">Broadcom Firmware Format</a></div>
</li>
</ul>

</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>doc/techref/flash.layout.txt</bdi> · Last modified: 2015/04/29 06:55 by <bdi>Kathrincolyn</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="flash.layout?do=edit"  class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="flash.layout?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="flash.layout?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="flash.layout#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img src="../../lib/images/license/button/cc-by-nc-sa.png" alt="CC Attribution-Noncommercial-Share Alike 3.0 Unported" /></a>        <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../lib/tpl/openwrt/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="../../lib/tpl/openwrt/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../lib/tpl/openwrt/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../lib/tpl/openwrt/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../lib/tpl/openwrt/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="../../lib/exe/indexer.php?id=doc%253Atechref%253Aflash.layout&amp;1432265491" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if ( lte IE 7 | IE 8 ) ]></div><![endif]-->
</body>
</html>
