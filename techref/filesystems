<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>Filesystems [OpenWrt Wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="doc,techref,filesystems"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="OpenWrt Wiki"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="filesystems?do=index" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Recent changes" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="../../feed.php?mode=list&amp;ns=doc:techref"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/doc/techref/filesystems"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../../_export/raw/doc/techref/filesystems"/>
<link rel="canonical" href="filesystems"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php?t=openwrt&amp;tseed=6f44f363dc87908d905dc56ff3acbfc4"/>
<script type="text/javascript">/*<![CDATA[*/var NS='doc:techref';var JSINFO = {"id":"doc:techref:filesystems","namespace":"doc:techref"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php?tseed=6f44f363dc87908d905dc56ff3acbfc4"></script>
<script type="text/javascript" charset="utf-8">/*<![CDATA[*/jQuery(function(){
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1432265711 166.182.3.62';
			document.forms[i].appendChild(myElement);
		}
	}
});
/*!]]>*/</script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../lib/tpl/openwrt/images/favicon.ico" />
<link rel="apple-touch-icon" href="../../lib/tpl/openwrt/images/apple-touch-icon.png" />
    </head>

<body>
    <!--[if lte IE 7 ]><div id="IE7"><![endif]--><!--[if IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_openwrt     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="filesystems#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="../../start"  accesskey="h" title="[H]"><img src="../../lib/tpl/openwrt/images/logo.png" width="386" height="98" alt="" /> <span>OpenWrt Wiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="filesystems?do=register"  class="action register" rel="nofollow" title="Register">Register</a></li><li><a href="filesystems?do=login&amp;sectok=382740b13d95f946eed36caa57076b4a"  class="action login" rel="nofollow" title="Login">Login</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="../../start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="../../doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="doc:techref:filesystems" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Login</option><option value="register">Register</option></optgroup></select><input type="submit" value="&gt;" /></div></form>            </div>
            <ul>
                <li><a href="filesystems?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Recent changes [R]">Recent changes</a></li><li><a href="filesystems?do=media&amp;ns=doc%253Atechref"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="filesystems?do=index"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="../../start" class="wikilink1" title="start">OpenWrt Wiki</a></bdi></span> » <bdi><a href="../start" class="wikilink1" title="doc:start">Documentation</a></bdi> » <bdi><a href="../techref.1" class="wikilink1" title="doc:techref:start">Technical Reference</a></bdi> » <bdi><span class="curid"><a href="filesystems" class="wikilink1" title="doc:techref:filesystems">Filesystems</a></span></bdi></div>
                                    <div class="plugin_multilingual">
        <ul>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/cz/doc/techref/filesystems" class="media" title="cz:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=aff589&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fcz.gif" class="media" title="Čeština (Czech)" alt="Čeština (Czech)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/de/doc/techref/filesystems" class="media" title="de:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=e24010&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fde.gif" class="media" title="Deutsch (German)" alt="Deutsch (German)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <span class="curid"><a href="filesystems" class="media" title="doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=2a37ae&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fgb.gif" class="media" title="English" alt="English" /></a></span>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/es/doc/techref/filesystems" class="media" title="es:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=46c004&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fmx.gif" class="media" title="Español (Spanish, Mexico)" alt="Español (Spanish, Mexico)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/fr/doc/techref/filesystems" class="media" title="fr:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=a5beba&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ffr.gif" class="media" title="Français (French)" alt="Français (French)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/hu/doc/techref/filesystems" class="media" title="hu:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=6b5470&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fhu.gif" class="media" title="Magyar (Hungarian)" alt="Magyar (Hungarian)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/jp/doc/techref/filesystems" class="media" title="jp:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f999fc&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fjp.gif" class="media" title="日本語 (Japanese)" alt="日本語 (Japanese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pl/doc/techref/filesystems" class="media" title="pl:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=c805c0&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fpl.gif" class="media" title="Poliski (Polish)" alt="Poliski (Polish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pt-br/doc/techref/filesystems" class="media" title="pt-br:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=13127d&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fbr.gif" class="media" title="Português brasileiro (Portuguese, Brasil)" alt="Português brasileiro (Portuguese, Brasil)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../ru/doc/techref/filesystems" class="media" title="ru:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=66ab5e&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fru.gif" class="media" title="Русский (Russsian)" alt="Русский (Russsian)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/tr/doc/techref/filesystems" class="media" title="tr:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f4beed&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ftr.gif" class="media" title="Tϋrkçe (Turkish)" alt="Tϋrkçe (Turkish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../zh-cn/doc/techref/filesystems" class="media" title="zh-cn:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=93625a&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-cn.gif" class="media" title="官話/官话 (Chinese)" alt="官話/官话 (Chinese)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-tw/doc/techref/filesystems" class="media" title="zh-tw:doc:techref:filesystems"><img src="../../lib/exe/fetch.php?cache=&amp;tok=b56198&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-tw.gif" class="media" title="臺灣華語 (Taiwanese)" alt="臺灣華語 (Taiwanese)" /></a>
              </div>
            </div>
          </li>
        </ul>
      </div>
        </div>
    
    
    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">

                <div class="pageId"><span>doc:techref:filesystems</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="filesystems#overlayfs">overlayfs</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#tmpfs">tmpfs</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#squashfs">SquashFS</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#jffs2">JFFS2</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#ubifs">UBIFS</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#ext2">ext2</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#other_filesystems">Other filesystems</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#implementation_in_openwrt">Implementation in OpenWrt</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="filesystems#boot_process">Boot process</a></div></li>
<li class="level2"><div class="li"><a href="filesystems#explanation">Explanation</a></div></li>
<li class="level2"><div class="li"><a href="filesystems#explanation_2">Explanation 2</a></div></li>
<li class="level2"><div class="li"><a href="filesystems#technical_details">Technical Details</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="filesystems#can_we_switch_the_filesystem_to_be_entirely_jffs2">Can we switch the filesystem to be entirely JFFS2?</a></div></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><div class="li"><a href="filesystems#notes">Notes</a></div></li>
<li class="level1"><div class="li"><a href="filesystems#archive">Archive</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="filesystems">Filesystems</h1>
<div class="level1">

<p>
This article is about file systems in the OpenWrt installation on built-in flash.
For general external support for installing file systems on other devices, including partitioning and mounting see <a href="../howto/storage" class="wikilink1" title="doc:howto:storage">this page about general storage</a>.
</p>

<p>
Please read about the → <a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">flash.layout</a> as well. Also, note that there are two types of flash memory: <a href="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash">NOR flash</a> and <a href="http://en.wikipedia.org/wiki/Flash_memory#NAND_flash" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Flash_memory#NAND_flash">NAND flash</a>. Also, you should read up on <code><a href="mtd" class="wikilink1" title="doc:techref:mtd">mtd</a></code>. 
</p>

</div>

<h2 class="sectionedit2" id="overlayfs">overlayfs</h2>
<div class="level2">

<p>
Used to merge two filesystems, one read-only and the other writable.  <a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">flash.layout</a> explains how this is used in OpenWRT.
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.38/209-overlayfs.patch?rev=26213" class="urlextern" title="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.38/209-overlayfs.patch?rev=26213"  rel="nofollow">https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.38/209-overlayfs.patch?rev=26213</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://lwn.net/Articles/447650/" class="urlextern" title="http://lwn.net/Articles/447650/"  rel="nofollow">http://lwn.net/Articles/447650/</a></div>
</li>
<li class="level1"><div class="li"> proposed to be mainlined in Linux kernel 3.18, see <a href="https://lkml.org/lkml/2014/9/29/350" class="urlextern" title="https://lkml.org/lkml/2014/9/29/350"  rel="nofollow">Kernel mailing list</a>, <a href="https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/tree/Documentation/filesystems/overlayfs.txt" class="urlextern" title="https://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/tree/Documentation/filesystems/overlayfs.txt"  rel="nofollow">/Documentation/filesystems/overlayfs.txt</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://git.kernel.org/cgit/linux/kernel/git/mszeredi/vfs.git/tree/Documentation/filesystems/overlayfs.txt?h=overlayfs.current" class="urlextern" title="https://git.kernel.org/cgit/linux/kernel/git/mszeredi/vfs.git/tree/Documentation/filesystems/overlayfs.txt?h=overlayfs.current"  rel="nofollow"> Overlayfs documentation</a> in the official development tree</div>
</li>
<li class="level1"><div class="li"> Overlayfs&#039;s support for inotify mechanisms is not complete yet. Events like IN_CLOSE_WRITE cannot be notified to listening process.</div>
</li>
</ul>

</div>

<h2 class="sectionedit3" id="tmpfs">tmpfs</h2>
<div class="level2">

<p>
<a href="http://en.wikipedia.org/wiki/tmpfs" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/tmpfs">tmpfs</a>
</p>
<ul>
<li class="level1"><div class="li"> <code>/tmp</code> resides on a tmpfs-partition and <code>/var</code> is a symlink to it; <code>/dev</code> resides on a little tmpfs partition of its own</div>
</li>
<li class="level1"><div class="li"> + no wear leveling</div>
</li>
<li class="level1"><div class="li"> - volatile (doesn&#039;t survive a reboot)</div>
</li>
<li class="level1"><div class="li"> <a href="http://lxr.free-electrons.com/source/Documentation/filesystems/tmpfs.txt" class="urlextern" title="http://lxr.free-electrons.com/source/Documentation/filesystems/tmpfs.txt"  rel="nofollow">Kernel documentation on tmpfs</a></div>
</li>
</ul>

</div>

<h2 class="sectionedit4" id="squashfs">SquashFS</h2>
<div class="level2">

<p>
<a href="http://en.wikipedia.org/wiki/SquashFS" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/SquashFS">SquashFS</a> is a <em>read only</em> compressed filesystem. While <a href="http://en.wikipedia.org/wiki/gzip" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/gzip">gzip</a> is available, at OpenWrt it uses <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a> for the compression. Since SquashFS is a read only filesystem, it doesn&#039;t need to align the data, allowing it to pack the files tighter thus taking up significantly less space than JFFS2 (20-30% savings over a JFFS2 filesystem)!
</p>
<ul>
<li class="level1"><div class="li"> + taking up as little space as possible</div>
</li>
<li class="level1"><div class="li"> + allowing the implementation of an idiot proof <a href="../howto/generic.failsafe" class="wikilink1" title="doc:howto:generic.failsafe">FailSafe</a> for recovery, since it is not possible to write to it</div>
</li>
<li class="level1"><div class="li"> - read only</div>
</li>
<li class="level1"><div class="li"> - waste space, since each time a file contained on it is modified, actually a copy of it is being copied to the second (JFFS2) partition</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> <a href="http://lxr.free-electrons.com/source/Documentation/filesystems/squashfs.txt" class="urlextern" title="http://lxr.free-electrons.com/source/Documentation/filesystems/squashfs.txt"  rel="nofollow">Kernel documentation on SquashFS</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://tree.celinuxforum.org/CelfPubWiki/SquashFsComparisons" class="urlextern" title="http://tree.celinuxforum.org/CelfPubWiki/SquashFsComparisons"  rel="nofollow">SquashFs Performance Comparisons</a></div>
</li>
<li class="level1"><div class="li"> There is a generic problem when running SquashFS on NAND: The issue is that SquashFS has no bad block management at all and requires all blocks on order; but for proper NAND bad block management you also need to be able to skip bad blocks and occasionally relocate blocks (see <a href="http://www.infradead.org/pipermail/linux-mtd/2006-April/015386.html" class="urlextern" title="http://www.infradead.org/pipermail/linux-mtd/2006-April/015386.html"  rel="nofollow">squashfs and NAND flash</a>). That&#039;s why raw SquashFS is a bad idea on NAND (it works if you use a FTL like UBIFS).</div>
</li>
</ul>

</div>

<h2 class="sectionedit5" id="jffs2">JFFS2</h2>
<div class="level2">

<p>
<a href="http://en.wikipedia.org/wiki/JFFS2" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/JFFS2">JFFS2</a> is a <em>writable</em> compressed filesystem with <em><a href="http://en.wikipedia.org/wiki/Journaling file system" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Journaling file system">journaling</a></em> and <em><a href="http://en.wikipedia.org/wiki/wear leveling" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/wear leveling">wear leveling</a></em> using <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a> for the compression.
</p>
<ul>
<li class="level1"><div class="li"> + is writable, has journaling and wear leveling</div>
</li>
<li class="level1"><div class="li"> + is cool</div>
</li>
<li class="level1"><div class="li"> - is compressed, so a program (<code><a href="opkg" class="wikilink1" title="doc:techref:opkg">opkg</a></code> in particular) cannot know in advance how much space a package will occupy</div>
</li>
<li class="level1"><div class="li"> + is compressed, so a program (which is preinstalled) takes much less space, so effectively you have more space</div>
</li>
</ul>

</div>

<h2 class="sectionedit6" id="ubifs">UBIFS</h2>
<div class="level2">

<p>
<a href="http://en.wikipedia.org/wiki/UBIFS" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/UBIFS">UBIFS</a> is a file system for <a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">raw flash</a>. It is used in OpenWrt NAND targets since :<img src="../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />: around r40364
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://lxr.free-electrons.com/source/Documentation/filesystems/ubifs.txt" class="urlextern" title="http://lxr.free-electrons.com/source/Documentation/filesystems/ubifs.txt"  rel="nofollow">Kernel documentation on UBIFS</a></div>
</li>
</ul>

</div>

<h2 class="sectionedit7" id="ext2">ext2</h2>
<div class="level2">

<p>
Ext2/3/4 is used on x86, x86-64 and for some arch with SD-card rootfs :<img src="../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />: .
<a href="http://en.wikipedia.org/wiki/ext2" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/ext2">ext2</a>
</p>
<ul>
<li class="level1"><div class="li"> + a program (<code><a href="opkg" class="wikilink1" title="doc:techref:opkg">opkg</a></code> in particularly) knows how much space is left!</div>
</li>
<li class="level1"><div class="li"> + good ol&#039; veteran <abbr title="Free &amp; Open-Source Software">FOSS</abbr> file system</div>
</li>
<li class="level1"><div class="li"> - no journaling</div>
</li>
<li class="level1"><div class="li"> - no wear leveling</div>
</li>
<li class="level1"><div class="li"> - no transparent compression</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> <a href="http://lxr.free-electrons.com/source/Documentation/filesystems/ext2.txt" class="urlextern" title="http://lxr.free-electrons.com/source/Documentation/filesystems/ext2.txt"  rel="nofollow">Kernel documentation on ext2</a></div>
</li>
</ul>

</div>

<h2 class="sectionedit8" id="other_filesystems">Other filesystems</h2>
<div class="level2">

<p>
OpenWrt does not use other filesystems as rootfs. It supports several filesystem attached to via various mechanisms like USB,SATA or network. For a list see <a href="../howto/storage" class="wikilink1" title="doc:howto:storage">storage</a>.
</p>

</div>

<h2 class="sectionedit9" id="implementation_in_openwrt">Implementation in OpenWrt</h2>
<div class="level2">

<p>
The <a href="flash.layout" class="wikilink1" title="doc:techref:flash.layout">Flash.Layout</a> article documents how OpenWrt uses both SquashFS and JFFS2 filesystems combined into one filesystem by overlayfs. The kernel is also stored separately from these partitions in raw flash. When the kernel is built, it is also compressed with <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a> and <a href="http://en.wikipedia.org/wiki/gzip" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/gzip">gzip</a>, as documented in <a href="../howto/imagegenerator" class="wikilink1" title="doc:howto:obtain.firmware.generate">obtain.firmware.generate</a>.
</p>

</div>

<h3 class="sectionedit10" id="boot_process">Boot process</h3>
<div class="level3">

<p>
System bootup is as follows: →<a href="process.boot" class="wikilink1" title="doc:techref:process.boot">process.boot</a>
</p>
<ol>
<li class="level1"><div class="li"> kernel boots from a known raw partition (without a FS), scans mtd partition <em>rootfs</em> for a valid superblock and mounts the SquashFS partition (containing <code>/etc</code>) then runs <code><a href="../howto/notuci.config#etcpreinit" class="wikilink1" title="doc:howto:notuci.config">/etc/preinit</a></code>. (More info at <span class="curid"><a href="filesystems#technicaldetails" class="wikilink1" title="doc:techref:filesystems">technical.details</a></span>)</div>
</li>
<li class="level1"><div class="li"> <code>/etc/preinit</code> runs <code><a href="https://dev.openwrt.org/browser/trunk/package/base-files/files/sbin/mount_root" class="urlextern" title="https://dev.openwrt.org/browser/trunk/package/base-files/files/sbin/mount_root"  rel="nofollow">/sbin/mount_root</a></code></div>
</li>
<li class="level1"><div class="li"> <code>mount_root</code> mounts the JFFS2 partition (<code>/overlay</code>) and <strong>combines</strong> it with the SquashFS partition (<code>/rom</code>) to create a new <em>virtual root filesystem</em> (<code>/</code>)</div>
</li>
<li class="level1"><div class="li"> bootup continues with <code>/sbin/init</code></div>
</li>
</ol>

<p>
<strong> * </strong> <code>/overlay</code> was previously named <code>/jffs2</code>
</p>

</div>

<h3 class="sectionedit11" id="explanation">Explanation</h3>
<div class="level3">

<p>
Both SquashFS and JFFS2 are compressed filesystems using <a href="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Lempel–Ziv–Markov chain algorithm">LZMA</a> for the compression. SquashFS is a <em>read only</em> filesystem while JFFS2 is a writable filesystem with <em>journaling</em> and <em>wear leveling</em>.
</p>

<p>
Our job when writing the firmware is to put as much common functionality on SquashFS while not wasting space with unwanted features. Additional features can always be installed onto JFFS2 by the user. The use of <code>mini_fo</code>/<code>overlayfs</code> means that the filesystem is presented as one large writable filesystem to the user with no visible boundary between SquashFS and JFFS2 – files are simply copied to JFFS2 when they&#039;re written.
</p>

<p>
It&#039;s not all without side effects however -
</p>

<p>
The fact that we pack things so tightly in flash means that if the firmware ever changes, the size and location of the JFFS2 partition also changes, potentially wiping out a large chunk of JFFS2 data and corrupting the filesystem. To deal with this, we&#039;ve implemented a policy that after each reflash the JFFS2 data is reformatted. The trick to doing that is a special value, <code>0xdeadc0de</code>; when this value appears in a JFFS2 partition, everything from that point to the end of the partition is wiped. So, hidden at the end of the firmware images, is the value 0xdeadcode, positioned such that it becomes the start of the JFFS2 partition.
</p>

<p>
The fact that we use a combination of compressed and partially read only filesystems also has an interesting effect on package management:<br/>

In particular, you need to be careful what packages you update. While <code><a href="opkg" class="wikilink1" title="doc:techref:opkg">OPKG</a></code> is more than happy to install an updated package on JFFS2, it&#039;s unable to remove the original package from SquashFS; the end result is that you slowly start using more and more space until the JFFS2 partition is filled. The opkg util really has no idea how much space is available on the JFFS2 partition since it&#039;s compressed, and so it will blindly keep going until the opkg system crashes – at that point you have so little space you probably can&#039;t even use opkg to remove anything.
</p>

</div>

<h3 class="sectionedit12" id="explanation_2">Explanation 2</h3>
<div class="level3">

<p>
On many embedded targets that use  <a href="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Flash_memory#NOR_flash">NOR flash</a> for the root filesystem, OpenWrt implements a clever trick to get the most out of the limited flash memory capacity while retaining flexibility for the end-user:
</p>

<p>
Basically, during the image creation, all of the rootfs contents is packed up in a SquashFS filesystem – a highly efficient filesystem
with compression support. There&#039;s one important detail about it though: it is a read-only filesystem. To overcome this limitation OpenWrt uses the remaining portion of the NOR rootfs partition to store an additional read/write jffs2 filesystem which is &quot;overlayed&quot; on top of the rootfs (that is, allowing to read unchanged files from the SquashFS but storing all the modifications made to the jffs2 part).
</p>

<p>
This design has another important advantage for the end-user: even
when the read/write partition is in total mess, he can always boot to
the failsafe mode (which mounts only the squashfs part) and proceed
from there.
</p>

</div>

<h3 class="sectionedit13" id="technical_details">Technical Details</h3>
<div class="level3">

<p>
The kernel boot process involves discovering of partitions within the NOR flash and it can be done by various target-dependent means:
</p>
<ul>
<li class="level1"><div class="li"> some bootloaders store a partition table at a known location</div>
</li>
<li class="level1"><div class="li"> some pass the partition layout via kernel command line</div>
</li>
<li class="level1"><div class="li"> some targets require specifying the kernel command line at the compile time (thus overriding the one provided by the bootloader).</div>
</li>
</ul>

<p>
Either way, if there is a partition named <code>rootfs</code> and <code>MTD_ROOTFS_ROOT_DEV</code> kernel config option is set to <code>yes</code>, this partition is automatically used for the root filesystem.
</p>

<p>
After that, if <code>MTD_ROOTFS_SPLIT</code> is enabled, the kernel adjusts the <code>rootfs</code> partition size to the minimum required by the particular SquashFS image and automatically adds <code>rootfs_data</code> to the list of the available mtd partitions setting its beginning to the first appropriate address after the SquashFS end and size to the remainder of the original <code>rootfs</code> partition. The resulting list is stored in RAM only, so no partition table of any kind gets actually modified.
</p>

<p>
For more details please refer to the actual patch at:
<a href="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/065-rootfs_split.patch" class="urlextern" title="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/065-rootfs_split.patch"  rel="nofollow">https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/065-rootfs_split.patch</a>
</p>

<p>
For overlaying a special <code>mini_fo</code> filesystem is used, the <code>README</code> is available from the sources at
<a href="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/209-mini_fo.patch" class="urlextern" title="https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/209-mini_fo.patch"  rel="nofollow">https://dev.openwrt.org/browser/trunk/target/linux/generic/patches-2.6.37/209-mini_fo.patch</a>
</p>
<div class="table sectionedit14"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />: Please feel free to merge Explanation 1 with Explanation 2 </td>
	</tr>
</table></div>

</div>

<h4 id="can_we_switch_the_filesystem_to_be_entirely_jffs2">Can we switch the filesystem to be entirely JFFS2?</h4>
<div class="level4">

<p>
<strong><em><code>Note:</code></em></strong>: It is possible to contain the entire root filesystem on a JFFS2-Partition only, instead of a combination of both.
The advantage is that changes to included files no longer leaves behind an old copy on the read only filesystem. So you could end up saving space.
The disadvantage of this would be, that you have no failsafe any longer and also, JFFS2 takes significantly more space then SquashFS.
</p>

<p>
Yes, it&#039;s technically possible, but a bit of a mess to actually pull off. The firmware has to be loaded as a trx file, which means that you have to put the JFFS2 data inside of the trx. But, as I said above, the trx has a checksum, meaning that if you ever change that data, you invalidate the checksum. The solution is that you install with the JFFS2 data contained within the trx, and then change the trx-boundaries at runtime. The end result is a single JFFS2 partition for the root filesystem. Why someone would want to do it is beyond me; it takes more space, and while it would allow you to upgrade the contents of the filesystem you would still be unable to replace the kernel (outside of the filesystem), meaning that a seamless upgrade between releases is still not possible! Having SquashFS gives you a failsafe mechanism where you can always ignore the JFFS2 partition and boot directly off SquashFS, or restore files to their original SquashFS versions.
</p>

<p>
I used to have a trick where I could convert a SquashFS install to a JFFS2 install at runtime by copying all the data onto the SquashFS partition and changing the partition boundaries. I never really had much use for the util – not to mention it required a rather large flash to store both SquashFS and JFFS2 copies of the root during transition – so support for it was dropped.
</p>

</div>

<h2 class="sectionedit15" id="notes">Notes</h2>
<div class="level2">

<p>
Example pictures: on formated partition  / how data is stored (and addressed on ext3)
</p>
<ul>
<li class="level1"><div class="li"> how data is stored and addressed by ext2:</div>
</li>
<li class="level1"><div class="li"> how data is stored and addressed by ext3:</div>
</li>
<li class="level1"><div class="li"> how data is stored and addressed by SquashFS:</div>
</li>
<li class="level1"><div class="li"> how data is stored and addressed by JFFS2:</div>
</li>
</ul>

</div>

<h2 class="sectionedit16" id="archive">Archive</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> see <a href="filesystems.old" class="wikilink1" title="doc:techref:filesystems.old">filesystems.old</a></div>
</li>
</ul>

</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>doc/techref/filesystems.txt</bdi> · Last modified: 2015/04/26 08:58 by <bdi>theoradicus</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="filesystems?do=edit"  class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="filesystems?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="filesystems?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="filesystems#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img src="../../lib/images/license/button/cc-by-nc-sa.png" alt="CC Attribution-Noncommercial-Share Alike 3.0 Unported" /></a>        <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../lib/tpl/openwrt/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="../../lib/tpl/openwrt/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../lib/tpl/openwrt/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../lib/tpl/openwrt/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../lib/tpl/openwrt/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="../../lib/exe/indexer.php?id=doc%253Atechref%253Afilesystems&amp;1432265711" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if ( lte IE 7 | IE 8 ) ]></div><![endif]-->
</body>
</html>
