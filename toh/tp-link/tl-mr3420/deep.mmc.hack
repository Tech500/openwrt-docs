<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>Deep MMC Mod [OpenWrt Wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="toh,tp-link,tl-mr3420,deep.mmc.hack"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../lib/exe/opensearch.php" title="OpenWrt Wiki"/>
<link rel="start" href="../../../index.html"/>
<link rel="contents" href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=index" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Recent changes" href="../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="http://wiki.openwrt.org/feed.php?mode=list&amp;ns=toh:tp-link:tl-mr3420"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="http://wiki.openwrt.org/_export/xhtml/toh/tp-link/tl-mr3420/deep.mmc.hack"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="http://wiki.openwrt.org/_export/raw/toh/tp-link/tl-mr3420/deep.mmc.hack"/>
<link rel="canonical" href="deep.mmc.hack"/>
<link rel="stylesheet" type="text/css" href="../../../lib/exe/css.php?t=openwrt&amp;tseed=6f44f363dc87908d905dc56ff3acbfc4"/>
<script type="text/javascript">/*<![CDATA[*/var NS='toh:tp-link:tl-mr3420';var JSINFO = {"id":"toh:tp-link:tl-mr3420:deep.mmc.hack","namespace":"toh:tp-link:tl-mr3420"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../lib/exe/js.php?tseed=6f44f363dc87908d905dc56ff3acbfc4"></script>
<script type="text/javascript" charset="utf-8">/*<![CDATA[*/jQuery(function(){
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1432279611 166.182.3.57';
			document.forms[i].appendChild(myElement);
		}
	}
});
/*!]]>*/</script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../../lib/tpl/openwrt/images/favicon.ico" />
<link rel="apple-touch-icon" href="../../../lib/tpl/openwrt/images/apple-touch-icon.png" />
    </head>

<body>
    <!--[if lte IE 7 ]><div id="IE7"><![endif]--><!--[if IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_openwrt     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="deep.mmc.hack#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="../../../start"  accesskey="h" title="[H]"><img src="../../../lib/tpl/openwrt/images/logo.png" width="386" height="98" alt="" /> <span>OpenWrt Wiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=register"  class="action register" rel="nofollow" title="Register">Register</a></li><li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=login&amp;sectok=382740b13d95f946eed36caa57076b4a"  class="action login" rel="nofollow" title="Login">Login</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="../../../start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="../../../doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="toh:tp-link:tl-mr3420:deep.mmc.hack" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Login</option><option value="register">Register</option></optgroup></select><input type="submit" value="&gt;" /></div></form>            </div>
            <ul>
                <li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Recent changes [R]">Recent changes</a></li><li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=media&amp;ns=toh%3Atp-link%3Atl-mr3420"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=index"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="../../../start" class="wikilink1" title="start">OpenWrt Wiki</a></bdi></span> » <bdi><a href="../../start" class="wikilink1" title="toh:start">Table of Hardware</a></bdi> » <bdi><a href="../start" class="wikilink1" title="toh:tp-link:start">TP-Link</a></bdi> » <bdi><a href="../tl-mr3220" class="wikilink1" title="toh:tp-link:tl-mr3420">TP-Link TL-MR3420, TL-MR3220, TL-WR841ND v7 &amp; TL-WR842ND</a></bdi> » <bdi><span class="curid"><a href="deep.mmc.hack" class="wikilink1" title="toh:tp-link:tl-mr3420:deep.mmc.hack">Deep MMC Mod</a></span></bdi></div>
                                    <div class="plugin_multilingual">
        <ul>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/cz/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="cz:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=aff589&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fcz.gif" class="media" title="Čeština (Czech)" alt="Čeština (Czech)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/de/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="de:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=e24010&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fde.gif" class="media" title="Deutsch (German)" alt="Deutsch (German)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <span class="curid"><a href="deep.mmc.hack" class="media" title="toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=2a37ae&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fgb.gif" class="media" title="English" alt="English" /></a></span>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/es/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="es:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=46c004&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fmx.gif" class="media" title="Español (Spanish, Mexico)" alt="Español (Spanish, Mexico)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/fr/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="fr:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=a5beba&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ffr.gif" class="media" title="Français (French)" alt="Français (French)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/hu/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="hu:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=6b5470&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fhu.gif" class="media" title="Magyar (Hungarian)" alt="Magyar (Hungarian)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/jp/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="jp:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=f999fc&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fjp.gif" class="media" title="日本語 (Japanese)" alt="日本語 (Japanese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pl/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="pl:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=c805c0&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fpl.gif" class="media" title="Poliski (Polish)" alt="Poliski (Polish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pt-br/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="pt-br:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=13127d&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fbr.gif" class="media" title="Português brasileiro (Portuguese, Brasil)" alt="Português brasileiro (Portuguese, Brasil)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <a href="../../../ru/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="ru:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=66ab5e&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fru.gif" class="media" title="Русский (Russsian)" alt="Русский (Russsian)" /></a>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/tr/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="tr:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=f4beed&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ftr.gif" class="media" title="Tϋrkçe (Turkish)" alt="Tϋrkçe (Turkish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-cn/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="zh-cn:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=93625a&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-cn.gif" class="media" title="官話/官话 (Chinese)" alt="官話/官话 (Chinese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-tw/toh/tp-link/tl-mr3420/deep.mmc.hack" class="media" title="zh-tw:toh:tp-link:tl-mr3420:deep.mmc.hack"><img src="../../../lib/exe/fetch.php?cache=&amp;tok=b56198&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-tw.gif" class="media" title="臺灣華語 (Taiwanese)" alt="臺灣華語 (Taiwanese)" /></a>
              </div>
            </div>
          </li>
        </ul>
      </div>
        </div>
    
    
    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">

                <div class="pageId"><span>toh:tp-link:tl-mr3420:deep.mmc.hack</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="deep.mmc.hack#how_to_connect_sd-card_to_spi_bus">How to connect SD-card to SPI bus</a></div></li>
<li class="level1"><div class="li"><a href="deep.mmc.hack#connection_mmcsd_memory_card_to_the_spi01_bus">Connection MMC/SD memory card to the spi0.1 bus</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="deep.mmc.hack#first_way_using_gpio_as_cs1">First way, using GPIO as CS1</a></div></li>
<li class="level2"><div class="li"><a href="deep.mmc.hack#second_way_using_internal_cs1">Second way, using Internal CS1</a></div></li>
<li class="level2"><div class="li"><a href="deep.mmc.hack#how_to_implement_the_hotplug_of_sd-card">How to implement the Hotplug of SD-card</a></div></li>
<li class="level2"><div class="li"><a href="deep.mmc.hack#modules_installation">Modules installation</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="deep.mmc.hack#first_way_using_external_modules">First way, using external modules</a></div></li>
<li class="level3"><div class="li"><a href="deep.mmc.hack#second_way_build_it_in_kernel">Second way, build it in kernel</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="deep.mmc.hack#testing">Testing</a></div></li>
<li class="level2"><div class="li"><a href="deep.mmc.hack#logs">Logs</a></div></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="deep_mmc_mod">Deep MMC Mod</h1>
<div class="level1">

</div>
<div class="plugin_include_content plugin_include__meta:infobox:cleanup" id="plugin_include__meta__infobox__cleanup">
<div class="level1">

<p>

<table class="inline" style="width:70%; margin-left:15%">
  <tr>
    <td style="border-left:6px solid #f57900; vertical-align:middle">
      <img src="../../../_media/meta/icons/tango/48px-cleanup.svg.png" alt="" style="float:left; margin-right:0.5em" />
      <strong>Cleanup Required!</strong><br />
      This page or section needs cleanup. You can <a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=edit">edit</a> this page to fix wiki markup, redundant content or outdated information.
    </td>
  </tr>
</table>

</p>

</div>
</div>
<div class="level1">

</div>

<h2 class="sectionedit4" id="how_to_connect_sd-card_to_spi_bus">How to connect SD-card to SPI bus</h2>
<div class="level2">
<div class="table sectionedit5"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  <img src="../../../lib/exe/fetch.php?tok=3612ca&amp;media=http%253A%252F%252Fwww.mal4x.ru%252Fdownload%252Ffile.php%253Fid%253D409%2526mode%253Dview%25261g1.png" class="media" title="First connection scheme" alt="First connection scheme" /> <br/>
<em>This connection scheme was successfully tested on TP-LINK MR3220 v1 device <br/>
(with GPIO power bus = 2.6V)</em>  </td>
	</tr>
	<tr class="row1">
		<td class="col0 centeralign">  <img class="media" src="http://i62.tinypic.com/2qitue0.jpg" border="0" alt="Second connection scheme" title="Second connection scheme">
<p>
 <br/>
<em>This connection scheme was successfully tested on TP-LINK WR841N v7.1 device <br/>
(with GPIO power bus = <img src="../../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />)</em>  
</p>
</td>
	</tr>
</table></div>

<p>
There are two ways to modify the device and the source code for this device by using any <strong>unused GPIO</strong> as CS1 /or/ <strong>Internal CS1</strong> (it used by SPI controller).<br/>

As well as two ways for installing the required modules for detect and use the SD memory card is connected to the SPI bus of device.<br/>

</p>

<p>
At software level, this modification is almost no different from <a href="../../../doc/howto/mmc_over_gpio" class="wikilink1" title="doc:howto:mmc_over_gpio">mmc_over_gpio</a>, the only difference in the <a href="http://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus#Independent_slave_SPI_configuration" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus#Independent_slave_SPI_configuration">Independent slave SPI configuration</a> of controller - that means we are using <code>CS0</code>, <code>CS1…CSn</code> line for each slave SPI-device. <br/>
On any platform with Atheros SoC we can see serial NOR-flash chip which is connected to SPI controller and it is used as primary boot device. Even if platform has a NAND-flash memory, it first loads the Bootloader or BIOS on Serial NOR flash memory, and only then NAND-flash memory is used.<br/>

</p>

<p>
How to build your own firmware, you can find at <a href="../../../doc/howto/easy.build" class="wikilink1" title="doc:howto:easy.build">this link</a> or with better explanations at <a href="../../../doc/howto/obtain.firmware.compile" class="wikilink1" title="doc:howto:build">this link</a>.<br/>

If you already have experience with compile own firmware, and you want to easy apply these changes as patch(es), you can just use this Linux console command:
<pre class="code">user@kali:/home/user/trunk# patch -u -p0 &lt; patchfile.patch</pre>

<em><img src="../../../_media/meta/icons/tango/48px-emblem-important.svg.png?w=16&amp;tok=d9f44c" class="media" title="Важно! " alt="Важно! " width="16" />Where <code>patchfile.patch</code> must be placed in the <code>trunk</code> directory.</em><br/>

</p>

</div>

<h2 class="sectionedit6" id="connection_mmcsd_memory_card_to_the_spi01_bus">Connection MMC/SD memory card to the spi0.1 bus</h2>
<div class="level2">

<p>
<strong>Note:</strong> Keep in mind, very often the unused GPIOs a pulled-down to the ground or pulled-up to the power bus via resistor - this may affect on detection of SD memory cards.
</p>
<div class="table sectionedit7"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  <img class="media" src="http://i59.tinypic.com/2gy0pzt.jpg" border="0"></td>
	</tr>
</table></div>

</div>

<h3 class="sectionedit8" id="first_way_using_gpio_as_cs1">First way, using GPIO as CS1</h3>
<div class="level3">

<p>
Recommended to use any unused GPIO-pin as CS1 for MMC/SD memory card.
</p>

</div>

<h5 id="main_changes_in_the_source_code_of_kernel">Main changes in the source code of kernel:</h5>
<div class="level5">

<p>
<pre class="code diff">Index: target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c
===================================================================
<span class="re3">--- target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c	<span class="br0">&#40;</span>revision 34914<span class="br0">&#41;</span></span>
<span class="re4">+++ target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c	<span class="br0">&#40;</span>working copy<span class="br0">&#41;</span></span>
<span class="re6">@@ -50,7 +50,7 @@</span>
 void __init ath79_register_m25p80<span class="br0">&#40;</span>struct flash_platform_data *pdata<span class="br0">&#41;</span>
 <span class="br0">&#123;</span>
 	ath79_spi_data.bus_num = <span class="nu0">0</span>;
<span class="re7">-	ath79_spi_data.num_chipselect = <span class="nu0">1</span>;</span>
<span class="re8">+	ath79_spi_data.num_chipselect = <span class="nu0">2</span>;</span>
 	ath79_spi0_cdata.is_flash = true;
 	ath79_spi_info<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.platform_data = pdata;
 	ath79_register_spi<span class="br0">&#40;</span>&amp;ath79_spi_data, ath79_spi_info, <span class="nu0">1</span><span class="br0">&#41;</span>;
Index: target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c
===================================================================
<span class="re3">--- target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c	<span class="br0">&#40;</span>revision 34914<span class="br0">&#41;</span></span>
<span class="re4">+++ target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c	<span class="br0">&#40;</span>working copy<span class="br0">&#41;</span></span>
<span class="re6">@@ -9,6 +9,9 @@</span>
  */
&nbsp;
 #include &lt;linux/gpio.h&gt;
<span class="re8">+#include &lt;linux/mmc/host.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/spi.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/mmc_spi.h&gt;</span>
&nbsp;
 #include &lt;asm/mach-ath79/ath79.h&gt;
&nbsp;
<span class="re6">@@ -16,12 +19,14 @@</span>
 #include &quot;dev-ap9x-pci.h&quot;
 #include &quot;dev-gpio-buttons.h&quot;
 #include &quot;dev-leds-gpio.h&quot;
<span class="re8">+#include &quot;dev-spi.h&quot;</span>
 #include &quot;dev-m25p80.h&quot;
 #include &quot;dev-usb.h&quot;
 #include &quot;machtypes.h&quot;
&nbsp;
 #define TL_MR3X20_GPIO_LED_QSS		<span class="nu0">0</span>
 #define TL_MR3X20_GPIO_LED_SYSTEM	<span class="nu0">1</span>
<span class="re8">+#define TL_MR3X20_GPIO_CS1_MMC		7</span>
 #define TL_MR3X20_GPIO_LED_3G		<span class="nu0">8</span>
&nbsp;
 #define TL_MR3X20_GPIO_BTN_RESET	<span class="nu0">11</span>
<span class="re6">@@ -32,6 +37,26 @@</span>
 #define TL_MR3X20_KEYS_POLL_INTERVAL	<span class="nu0">20</span>	/* msecs */
 #define TL_MR3X20_KEYS_DEBOUNCE_INTERVAL <span class="br0">&#40;</span><span class="nu0">3</span> * TL_MR3X20_KEYS_POLL_INTERVAL<span class="br0">&#41;</span>
&nbsp;
<span class="re8">+static struct mmc_spi_platform_data ath79_mmc_data = <span class="br0">&#123;</span></span>
<span class="re8">+       .get_ro = NULL,</span>
<span class="re8">+       .get_cd = NULL,</span>
<span class="re8">+       .detect_delay = 100, /* msecs */ </span>
<span class="re8">+	.ocr_mask	= MMC_VDD_32_33 | MMC_VDD_33_34,</span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
<span class="re8">+static struct ath79_spi_controller_data ath79_spi1_cdata = <span class="br0">&#123;</span></span>
<span class="re8">+	.cs_type = ATH79_SPI_CS_TYPE_GPIO,</span>
<span class="re8">+	.cs_line = TL_MR3X20_GPIO_CS1_MMC,</span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
<span class="re8">+static struct spi_board_info ath79_spi_info<span class="br0">&#91;</span><span class="br0">&#93;</span> = <span class="br0">&#123;</span></span>
<span class="re8">+	<span class="br0">&#123;</span></span>
<span class="re8">+		.bus_num	= 0,</span>
<span class="re8">+		.chip_select	= 1,</span>
<span class="re8">+		.max_speed_hz	= 25000000,</span>
<span class="re8">+		.modalias	= &quot;mmc_spi&quot;,</span>
<span class="re8">+		.platform_data	= &amp;ath79_mmc_data,</span>
<span class="re8">+		.controller_data = &amp;ath79_spi1_cdata,</span>
<span class="re8">+	<span class="br0">&#125;</span></span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
 static const char *tl_mr3x20_part_probes<span class="br0">&#91;</span><span class="br0">&#93;</span> = <span class="br0">&#123;</span>
 	&quot;tp-link&quot;,
 	NULL,
<span class="re6">@@ -97,6 +122,9 @@</span>
 	ath79_register_eth<span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>;
&nbsp;
 	ap91_pci_init<span class="br0">&#40;</span>ee, mac<span class="br0">&#41;</span>;
<span class="re8">+</span>
<span class="re8">+	spi_register_board_info<span class="br0">&#40;</span>ath79_spi_info,</span>
<span class="re8">+				ARRAY_SIZE<span class="br0">&#40;</span>ath79_spi_info<span class="br0">&#41;</span><span class="br0">&#41;</span>;</span>
 <span class="br0">&#125;</span>
&nbsp;
 static void __init tl_mr3x20_usb_setup<span class="br0">&#40;</span>void<span class="br0">&#41;</span></pre>

</p>

<p>
<br/>

</p>

</div>

<h3 class="sectionedit9" id="second_way_using_internal_cs1">Second way, using Internal CS1</h3>
<div class="level3">
<div class="table sectionedit10"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Internal CS </th><th class="col1"> AR71XX </th><th class="col2"> AR724X </th><th class="col3"> AR933X </th><th class="col4"> AR934X </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> CS1 </td><td class="col1" colspan="2"> usualy LED or BUTTON (GPIO0) </td><td class="col3"> UART In (GPIO9)<TD rowspan="2">
<p>
 any unused GPIOs(11-22) <br/>
(Software configurable <br/>
<a href="http://en.wikipedia.org/wiki/Multiplexer" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Multiplexer">multiplexer</a>) 
</p>
</td><td class="col4"></td>
	</tr>
	<tr class="row2">
		<td class="col0"> CS2 </td><td class="col1" colspan="2"> usualy LED or BUTTON (GPIO1) </td><td class="col3"> UART Out (GPIO10) </td><td class="col4"></td>
	</tr>
</table></div>

<p>
On platforms with AR71XX SoC: If you want to use the internal CS1 - you need to <a href="deep.mmc.hack#switchinggpio0tocs1onar71xxsoc" title="toh:tp-link:tl-mr3420:deep.mmc.hack ↵" class="wikilink1">turn off GPIO0</a>.
</p>

<p>
On platforms with AR724X SoC: If you want to use the internal CS1 - you need to <a href="deep.mmc.hack#switchinggpio0tocs1onar724xsoc" title="toh:tp-link:tl-mr3420:deep.mmc.hack ↵" class="wikilink1">turn off GPIO0</a>.
</p>

<p>
On platforms with AR933X SoC: If you want to use the internal CS1 - you need to <a href="deep.mmc.hack#turnoffuartandswitchinggpio9_rx_tocs1onar933xsoc" title="toh:tp-link:tl-mr3420:deep.mmc.hack ↵" class="wikilink1">turn off UART</a>.
</p>

<p>
On platforms with AR934X SoC: If you want to use the internal CS1 - you need to <a href="deep.mmc.hack#configuregpio11tocs1onar934xsoc" title="toh:tp-link:tl-mr3420:deep.mmc.hack ↵" class="wikilink1">configure GPIO to CS1</a>.
</p>

</div>

<h5 id="main_changes_in_the_source_code_of_kernel1">Main changes in the source code of kernel:</h5>
<div class="level5">

<p>
<pre class="code diff">Index: target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c
===================================================================
<span class="re3">--- target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c	<span class="br0">&#40;</span>revision 34914<span class="br0">&#41;</span></span>
<span class="re4">+++ target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c	<span class="br0">&#40;</span>working copy<span class="br0">&#41;</span></span>
<span class="re6">@@ -50,7 +50,7 @@</span>
 void __init ath79_register_m25p80<span class="br0">&#40;</span>struct flash_platform_data *pdata<span class="br0">&#41;</span>
 <span class="br0">&#123;</span>
 	ath79_spi_data.bus_num = <span class="nu0">0</span>;
<span class="re7">-	ath79_spi_data.num_chipselect = <span class="nu0">1</span>;</span>
<span class="re8">+	ath79_spi_data.num_chipselect = <span class="nu0">2</span>;</span>
 	ath79_spi0_cdata.is_flash = true;
 	ath79_spi_info<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>.platform_data = pdata;
 	ath79_register_spi<span class="br0">&#40;</span>&amp;ath79_spi_data, ath79_spi_info, <span class="nu0">1</span><span class="br0">&#41;</span>;
Index: target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c
===================================================================
<span class="re3">--- target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c	<span class="br0">&#40;</span>revision 34914<span class="br0">&#41;</span></span>
<span class="re4">+++ target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c	<span class="br0">&#40;</span>working copy<span class="br0">&#41;</span></span>
<span class="re6">@@ -9,13 +9,19 @@</span>
  */
&nbsp;
 #include &lt;linux/gpio.h&gt;
<span class="re8">+#include &lt;linux/mmc/host.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/spi.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/mmc_spi.h&gt;</span>
&nbsp;
 #include &lt;asm/mach-ath79/ath79.h&gt;
<span class="re8">+#include &lt;asm/mach-ath79/ar71xx_regs.h&gt;</span>
&nbsp;
<span class="re8">+#include &quot;common.h&quot;</span>
 #include &quot;dev-eth.h&quot;
 #include &quot;dev-ap9x-pci.h&quot;
 #include &quot;dev-gpio-buttons.h&quot;
 #include &quot;dev-leds-gpio.h&quot;
<span class="re8">+#include &quot;dev-spi.h&quot;</span>
 #include &quot;dev-m25p80.h&quot;
 #include &quot;dev-usb.h&quot;
 #include &quot;machtypes.h&quot;
<span class="re6">@@ -32,6 +38,26 @@</span>
 #define TL_MR3X20_KEYS_POLL_INTERVAL	<span class="nu0">20</span>	/* msecs */
 #define TL_MR3X20_KEYS_DEBOUNCE_INTERVAL <span class="br0">&#40;</span><span class="nu0">3</span> * TL_MR3X20_KEYS_POLL_INTERVAL<span class="br0">&#41;</span>
&nbsp;
<span class="re8">+static struct mmc_spi_platform_data ath79_mmc_data = <span class="br0">&#123;</span></span>
<span class="re8">+	.ocr_mask	= MMC_VDD_32_33 | MMC_VDD_33_34,</span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
<span class="re8">+static struct ath79_spi_controller_data ath79_spi1_cdata = <span class="br0">&#123;</span></span>
<span class="re8">+	.cs_type = ATH79_SPI_CS_TYPE_INTERNAL,</span>
<span class="re8">+	.cs_line = 1,</span>
<span class="re8">+<span class="br0">&#125;</span>; </span>
<span class="re8">+</span>
<span class="re8">+static struct spi_board_info ath79_spi_info<span class="br0">&#91;</span><span class="br0">&#93;</span> = <span class="br0">&#123;</span></span>
<span class="re8">+	<span class="br0">&#123;</span></span>
<span class="re8">+		.bus_num	= 0,</span>
<span class="re8">+		.chip_select	= 1,</span>
<span class="re8">+		.max_speed_hz	= 25000000,</span>
<span class="re8">+		.modalias	= &quot;mmc_spi&quot;,</span>
<span class="re8">+		.platform_data	= &amp;ath79_mmc_data,</span>
<span class="re8">+		.controller_data = &amp;ath79_spi1_cdata,</span>
<span class="re8">+	<span class="br0">&#125;</span></span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
 static const char *tl_mr3x20_part_probes<span class="br0">&#91;</span><span class="br0">&#93;</span> = <span class="br0">&#123;</span>
 	&quot;tp-link&quot;,
 	NULL,
<span class="re6">@@ -80,6 +106,9 @@</span>
 	u8 *mac = <span class="br0">&#40;</span>u8 *<span class="br0">&#41;</span> KSEG1ADDR<span class="br0">&#40;</span>0x1f01fc00<span class="br0">&#41;</span>;
 	u8 *ee = <span class="br0">&#40;</span>u8 *<span class="br0">&#41;</span> KSEG1ADDR<span class="br0">&#40;</span>0x1fff1000<span class="br0">&#41;</span>;
&nbsp;
<span class="re8">+	/* Enabling internal CS1, disable GPIO 0 */</span>
<span class="re8">+	ath79_gpio_function_enable<span class="br0">&#40;</span>AR724X_GPIO_FUNC_SPI_CS_EN1<span class="br0">&#41;</span>;</span>
<span class="re8">+</span>
 	ath79_register_m25p80<span class="br0">&#40;</span>&amp;tl_mr3x20_flash_data<span class="br0">&#41;</span>;
&nbsp;
 	ath79_register_gpio_keys_polled<span class="br0">&#40;</span>-<span class="nu0">1</span>, TL_MR3X20_KEYS_POLL_INTERVAL,
<span class="re6">@@ -97,6 +126,9 @@</span>
 	ath79_register_eth<span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>;
&nbsp;
 	ap91_pci_init<span class="br0">&#40;</span>ee, mac<span class="br0">&#41;</span>;
<span class="re8">+</span>
<span class="re8">+	spi_register_board_info<span class="br0">&#40;</span>ath79_spi_info,</span>
<span class="re8">+				ARRAY_SIZE<span class="br0">&#40;</span>ath79_spi_info<span class="br0">&#41;</span><span class="br0">&#41;</span>;</span>
 <span class="br0">&#125;</span>
&nbsp;
 static void __init tl_mr3x20_usb_setup<span class="br0">&#40;</span>void<span class="br0">&#41;</span> </pre>

</p>

</div>

<h5 id="switching_gpio0_to_cs1_on_ar71xx_soc">Switching GPIO0 to CS1 on AR71XX SoC:</h5>
<div class="level5">

<p>
<pre class="code c">	<span class="coMULTI">/* Enabling internal CS1, disable GPIO 0 */</span>
	ath79_gpio_function_enable<span class="br0">&#40;</span>AR71XX_GPIO_FUNC_SPI_CS1_EN<span class="br0">&#41;</span>;</pre>

</p>

</div>

<h5 id="switching_gpio0_to_cs1_on_ar724x_soc">Switching GPIO0 to CS1 on AR724X SoC:</h5>
<div class="level5">

<p>
<pre class="code c">	<span class="coMULTI">/* Enabling internal CS1, disable GPIO 0 */</span>
	ath79_gpio_function_enable<span class="br0">&#40;</span>AR724X_GPIO_FUNC_SPI_CS_EN1<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<em>(Already used in the above example.)</em>
</p>

</div>

<h5 id="turn_off_uart_and_switching_gpio9_rx_to_cs1_on_ar933x_soc">Turn off UART and switching GPIO9(Rx) to CS1 on AR933X SoC:</h5>
<div class="level5">

<p>
<pre class="code c">	<span class="coMULTI">/* Disable UART, enabling GPIO 9 and GPIO 10 */</span>
	ath79_gpio_function_disable<span class="br0">&#40;</span>AR933X_GPIO_FUNC_UART_EN<span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="coMULTI">/* Enabling internal CS1, disable GPIO 9 */</span>
	ath79_gpio_function_enable<span class="br0">&#40;</span>AR933X_GPIO_FUNC_SPI_CS_EN1<span class="br0">&#41;</span><span class="sy0">;</span></pre>

</p>

</div>

<h5 id="configure_gpio11_to_cs1_on_ar934x_soc">Configure GPIO11 to CS1 on AR934X SoC:</h5>
<div class="level5">

<p>
<pre class="code c">	<span class="coMULTI">/* We chose GPIO11 - for this example. You can use any unused GPIOs(11-22) */</span>
	<span class="co2">#define DEVICE_GPIO_CS1_MMC	11</span>
	<span class="coMULTI">/* custom register for CS2 (AR934X SoC), TODO in future ar71xx_regs.h */</span>
	<span class="co2">#define AR934X_GPIO_OUT_SPI_CS2		8</span>
	...
	<span class="coMULTI">/* Configure GPIO to MUX Select (CS1) */</span>
	ath79_gpio_output_select<span class="br0">&#40;</span>DEVICE_GPIO_CS1_MMC<span class="sy0">,</span> AR934X_GPIO_OUT_SPI_CS1<span class="br0">&#41;</span>;</pre>

</p>

<p>
<br/>

</p>

</div>

<h3 class="sectionedit11" id="how_to_implement_the_hotplug_of_sd-card">How to implement the Hotplug of SD-card</h3>
<div class="level3">
<div class="table sectionedit12"><table class="inline">
	<tr class="row0">
		<td class="col0 centeralign">  <img src="http://wiki.openwrt.org/lib/exe/fetch.php?tok=e608a8&amp;media=http%3A%2F%2Fwww.molex.com%2Fmx_upload%2Fsuperfamily%2Fmemory_card_connectors%2Fmemory_card_billboard.gif" class="media" alt="" />  </td>
	</tr>
	<tr class="row1">
		<td class="col0 centeralign">  <img src="../../../lib/exe/fetch.php?tok=dfd8ee&amp;media=http%253A%252F%252Fgumstix.8.x6.nabble.com%252Fattachment%252F640947%252F0%252Fmoz-screenshot-4.png" class="media" title="Connection scheme" alt="Connection scheme" /> <br/>
<em>We use <a href="https://www.google.com.ua/search?q=SD+Socket+OR+SD+card+holder+OR+SD+Memory+Card+connector&amp;tbm=isch" class="urlextern" title="https://www.google.com.ua/search?q=SD+Socket+OR+SD+card+holder+OR+SD+Memory+Card+connector&amp;tbm=isch"  rel="nofollow">SD Socket/SD card holder/SD Memory Card Connector</a> with special integrated buttons - <br/>
CD (Card Detect) and WP (Write Protect)</em>  </td>
	</tr>
</table></div>

<p>
Total we use two unused GPIOs: <strong>GPIO7→CS1</strong>, <strong>GPIO18→CD</strong>. <br/>

Create a new additional button on this example:
<pre class="code diff">diff --git a/target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c b/target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c
index 9323b31..<span class="re0">2c51142</span> <span class="nu0">100644</span>
<span class="re3">--- a/target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c</span>
<span class="re4">+++ b/target/linux/ar71xx/files/arch/mips/ath79/dev-m25p80.c</span>
<span class="re6">@@ -<span class="nu0">50</span>,<span class="nu0">7</span> +<span class="nu0">50</span>,<span class="nu0">7</span> @@ static struct ath79_spi_platform_data ath79_spi_data;</span>
 void __init ath79_register_m25p80<span class="br0">&#40;</span>struct flash_platform_data *pdata<span class="br0">&#41;</span>
 <span class="br0">&#123;</span>
 	ath79_spi_data.bus_num = 0;
<span class="re7">-	ath79_spi_data.num_chipselect = <span class="nu0">1</span>;</span>
<span class="re8">+	ath79_spi_data.num_chipselect = <span class="nu0">2</span>;</span>
 	ath79_spi0_cdata.is_flash = true;
 	ath79_spi_info<span class="br0">&#91;</span>0<span class="br0">&#93;</span>.platform_data = pdata;
 	ath79_register_spi<span class="br0">&#40;</span>&amp;ath79_spi_data, ath79_spi_info, <span class="nu0">1</span><span class="br0">&#41;</span>;
diff --git a/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c b/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c
index 5924ac5..<span class="re0">892d66</span>f <span class="nu0">100644</span>
<span class="re3">--- a/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c</span>
<span class="re4">+++ b/target/linux/ar71xx/files/arch/mips/ath79/mach-tl-mr3x20.c</span>
<span class="re6">@@ -<span class="nu0">9</span>,<span class="nu0">6</span> +<span class="nu0">9</span>,<span class="nu0">9</span> @@</span>
  */
&nbsp;
 #include &lt;linux/gpio.h&gt;
<span class="re8">+#include &lt;linux/mmc/host.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/spi.h&gt;</span>
<span class="re8">+#include &lt;linux/spi/mmc_spi.h&gt;</span>
&nbsp;
 #include &lt;asm/mach-ath79/ath79.h&gt;
&nbsp;
<span class="re6">@@ -<span class="nu0">17</span>,<span class="nu0">21</span> +<span class="nu0">20</span>,<span class="nu0">45</span> @@</span>
 #include &quot;dev-gpio-buttons.h&quot;
 #include &quot;dev-leds-gpio.h&quot;
 #include &quot;dev-m25p80.h&quot;
<span class="re8">+#include &quot;dev-spi.h&quot;</span>
 #include &quot;dev-usb.h&quot;
 #include &quot;machtypes.h&quot;
&nbsp;
 #define TL_MR3X20_GPIO_LED_QSS		0
 #define TL_MR3X20_GPIO_LED_SYSTEM	<span class="nu0">1</span>
<span class="re8">+#define TL_MR3X20_GPIO_CS1_MMC		7</span>
 #define TL_MR3X20_GPIO_LED_3G		<span class="nu0">8</span>
&nbsp;
 #define TL_MR3X20_GPIO_BTN_RESET	<span class="nu0">11</span>
 #define TL_MR3X20_GPIO_BTN_QSS		<span class="nu0">12</span>
<span class="re8">+#define TL_MR3X20_GPIO_BTN_MMC		18</span>
&nbsp;
 #define TL_MR3X20_GPIO_USB_POWER	<span class="nu0">6</span>
&nbsp;
 #define TL_MR3X20_KEYS_POLL_INTERVAL	<span class="nu0">20</span>	/* msecs */
 #define TL_MR3X20_KEYS_DEBOUNCE_INTERVAL <span class="br0">&#40;</span><span class="nu0">3</span> * TL_MR3X20_KEYS_POLL_INTERVAL<span class="br0">&#41;</span>
&nbsp;
<span class="re8">+static struct mmc_spi_platform_data ath79_mmc_pdata = <span class="br0">&#123;</span></span>
<span class="re8">+	.detect_delay	= <span class="nu0">250</span>,				/* card detection delay in msec */</span>
<span class="re8">+	.ocr_mask	= MMC_VDD_32_33 | MMC_VDD_33_34,</span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
<span class="re8">+static struct ath79_spi_controller_data ath79_spi1_cdata = <span class="br0">&#123;</span></span>
<span class="re8">+	.cs_type = ATH79_SPI_CS_TYPE_GPIO,</span>
<span class="re8">+	.cs_line = TL_MR3X20_GPIO_CS1_MMC,</span>
<span class="re8">+<span class="br0">&#125;</span>; </span>
<span class="re8">+</span>
<span class="re8">+static struct spi_board_info ath79_spi_info<span class="br0">&#91;</span><span class="br0">&#93;</span> __initdata = <span class="br0">&#123;</span></span>
<span class="re8">+	<span class="br0">&#123;</span></span>
<span class="re8">+		.bus_num	= 0,</span>
<span class="re8">+		.chip_select	= <span class="nu0">1</span>,</span>
<span class="re8">+		.max_speed_hz	= <span class="nu0">25000000</span>,</span>
<span class="re8">+		.modalias	= &quot;mmc_spi&quot;,</span>
<span class="re8">+		.platform_data	= &amp;ath79_mmc_pdata,</span>
<span class="re8">+		.controller_data = &amp;ath79_spi1_cdata,</span>
<span class="re8">+	<span class="br0">&#125;</span></span>
<span class="re8">+<span class="br0">&#125;</span>;</span>
<span class="re8">+</span>
 static const char *tl_mr3x20_part_probes<span class="br0">&#91;</span><span class="br0">&#93;</span> = <span class="br0">&#123;</span>
 	&quot;tp-link&quot;,
 	NULL,
<span class="re6">@@ -<span class="nu0">72</span>,<span class="nu0">6</span> +<span class="nu0">99</span>,<span class="nu0">13</span> @@ static struct gpio_keys_button tl_mr3x20_gpio_keys<span class="br0">&#91;</span><span class="br0">&#93;</span> __initdata = <span class="br0">&#123;</span></span>
 		.debounce_interval = TL_MR3X20_KEYS_DEBOUNCE_INTERVAL,
 		.gpio		= TL_MR3X20_GPIO_BTN_QSS,
 		.active_low	= <span class="nu0">1</span>,
<span class="re8">+	<span class="br0">&#125;</span>, <span class="br0">&#123;</span></span>
<span class="re8">+		.desc		= &quot;mmc&quot;,</span>
<span class="re8">+		.type		= EV_KEY,</span>
<span class="re8">+		.code		= KEY_MMC_BUTTON,</span>
<span class="re8">+		.debounce_interval = TL_MR3X20_KEYS_DEBOUNCE_INTERVAL,</span>
<span class="re8">+		.gpio		= TL_MR3X20_GPIO_BTN_MMC,</span>
<span class="re8">+		.active_low	= <span class="nu0">1</span>,</span>
 	<span class="br0">&#125;</span>
 <span class="br0">&#125;</span>;
&nbsp;
<span class="re6">@@ -<span class="nu0">97</span>,<span class="nu0">6</span> +<span class="nu0">131</span>,<span class="nu0">9</span> @@ static void __init tl_ap99_setup<span class="br0">&#40;</span>void<span class="br0">&#41;</span></span>
 	ath79_register_eth<span class="br0">&#40;</span>0<span class="br0">&#41;</span>;
&nbsp;
 	ap91_pci_init<span class="br0">&#40;</span>ee, mac<span class="br0">&#41;</span>;
<span class="re8">+</span>
<span class="re8">+	spi_register_board_info<span class="br0">&#40;</span>ath79_spi_info,</span>
<span class="re8">+				ARRAY_SIZE<span class="br0">&#40;</span>ath79_spi_info<span class="br0">&#41;</span><span class="br0">&#41;</span>;</span>
 <span class="br0">&#125;</span>
&nbsp;
 static void __init tl_mr3x20_usb_setup<span class="br0">&#40;</span>void<span class="br0">&#41;</span></pre>

<em> We could use GPIO to IRQ event as card detection (implemented in <code>mmc_spi</code> module) or GPIO to IRQ event as new hotplug SPI-device (implemented in standart SPI bus driver) - but in all this cases, it was found that it not support hotplug detection with <strong>removing</strong> the SD-card or SPI-device via the IRQ trigger.<br/>

   Or <img src="../../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" />   </em>
</p>

<p>
The solution was found without the use of IRQ trigger:
After build and compiling the firmware, we just added additional button with the name <strong><code>mmc</code></strong>.<br/>

Next, you need to <a href="../../../doc/howto/hardware.button#usingatheros00-buttonuci" class="wikilink1" title="doc:howto:hardware.button">create a configuration</a> for the button <strong><code>mmc</code></strong>:
<pre class="code bash">uci add system button
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.button=mmc
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.action=pressed
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.handler=<span class="st0">'echo &quot;spi0.1&quot; &gt; /sys/bus/spi/drivers/mmc_spi/bind'</span>
uci add system button
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.button=mmc
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.action=released
uci <span class="kw1">set</span> system.<span class="sy0">@</span>button<span class="br0">&#91;</span>-<span class="nu0">1</span><span class="br0">&#93;</span>.handler=<span class="st0">'echo &quot;spi0.1&quot; &gt; /sys/bus/spi/drivers/mmc_spi/unbind'</span>
uci commit system</pre>

</p>

<p>
<strong>Note:</strong> Before removing SD-card from the slot, it is recommended to use the console commands <strong><code>sync</code></strong> and <strong><code>unmount<strong> </strong>&lt;partition&gt;</code></strong> - for correctly unmounting of a partition. Because if we remove SD-card(after recording on it) without using unmount commands - we risk losing some not recorded data.
</p>

</div>

<h5 id="log_of_hotplug_process">Log of hotplug process:</h5>
<div class="level5">

<pre class="code">
...
[ 1968.380000] mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff
[ 1968.550000] mmc0: SD Status: Invalid Allocation Unit size.
[ 1968.560000] mmc0: host does not support reading read-only switch. assuming write-enable.
[ 1968.570000] mmc0: new SD card on SPI
[ 1968.570000] mmcblk0: mmc0:0000 00000 1.90 GiB 
[ 1968.580000]  mmcblk0: p1
<b><font size=4>[ 1980.340000] mmc0: SPI card removed</font></b>
[ 2008.900000] mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff
[ 2009.070000] mmc0: SD Status: Invalid Allocation Unit size.
[ 2009.080000] mmc0: host does not support reading read-only switch. assuming write-enable.
[ 2009.090000] mmc0: new SD card on SPI
[ 2009.090000] mmcblk0: mmc0:0000 00000 1.90 GiB
[ 2009.100000]  mmcblk0: p1
...
</pre>

<p>
<br/>

</p>

</div>

<h3 class="sectionedit13" id="modules_installation">Modules installation</h3>
<div class="level3">

</div>

<h4 id="first_way_using_external_modules">First way, using external modules</h4>
<div class="level4">
<div class="table sectionedit14"><table class="inline">
	<tr class="row0">
		<td class="col0"> <img src="../../../_media/meta/icons/tango/48px-emblem-important.svg.png" class="medialeft" title="Important!" alt="Important!" /> </td><td class="col1"> If we are using external modules <code>kmod-mmc</code> and <code>kmod-mmc-spi</code> - this does not allow to correctly mount <code><span style='color:magenta; '>/overlay</span></code> <br/>
or <code><span style='color:blue; '>/</span></code> (root) partitions through <a href="../../../doc/howto/extroot" class="wikilink1" title="doc:howto:extroot">extroot</a>. This problem is described in <a href="https://dev.openwrt.org/ticket/7768" class="urlextern" title="https://dev.openwrt.org/ticket/7768"  rel="nofollow">this old ticket</a>. <br/>
It&#039;s even considering that the use of these external modules, allow us to fully use the SD-card and mount it in the other mount points (except <a href="../../../doc/howto/extroot" class="wikilink1" title="doc:howto:extroot">extroot</a>). </td>
	</tr>
</table></div>

<p>
<strong> Update: </strong> The problem remained in <strong>r37142</strong> firmware revision. <br/>

For <a href="../../../doc/howto/extroot" class="wikilink1" title="doc:howto:extroot">extroot</a>, use Second way. <br/>

</p>

<p>
<br/>

</p>

</div>

<h4 id="second_way_build_it_in_kernel">Second way, build it in kernel</h4>
<div class="level4">
<div class="table sectionedit15"><table class="inline">
	<tr class="row0">
		<td class="col0"> <font size="24"; color="green" title="It works.">&#x2714</font></td><td class="col1"> By using this variant - NO need to install external modules <code>kmod-mmc</code>, <code>kmod-mmc-spi</code> and <code>kmod-fs-ext4</code>. <br/>
You can use the SD memory card as <a href="../../../doc/howto/extroot" class="wikilink1" title="doc:howto:extroot">extroot</a> (block-mount) with no problem. </td>
	</tr>
</table></div>

<p>
<br/>

</p>

</div>

<h5 id="integrating_modules_in_kernel">Integrating modules in kernel:</h5>
<div class="level5">

<p>
<pre class="code diff">Index: target/linux/ar71xx/config-<span class="nu0">3.7</span>
===================================================================
<span class="re3">--- target/linux/ar71xx/config-3.7	<span class="br0">&#40;</span>revision 35363<span class="br0">&#41;</span></span>
<span class="re4">+++ target/linux/ar71xx/config-3.7	<span class="br0">&#40;</span>working copy<span class="br0">&#41;</span></span>
<span class="re6">@@ -240,6 +240,10 @@</span>
 # CONFIG_SPI_RB4XX is not set
 # CONFIG_SPI_RB4XX_CPLD is not set
 # CONFIG_SPI_VSC7385 is not set
<span class="re8">+CONFIG_EXT4_FS=y</span>
<span class="re8">+CONFIG_MMC=y</span>
<span class="re8">+CONFIG_MMC_SPI=y</span>
<span class="re8">+CONFIG_MMC_BLOCK=y</span>
 CONFIG_SWCONFIG=y
 CONFIG_SWCONFIG_LEDS=y
 CONFIG_SYS_HAS_CPU_MIPS32_R2=y</pre>

<em>Besides MMC modules, we include the EXT4 module on the kernel level. <br/>

Also note that the Linux-kernel is updated regularly and the name of this configuration file contains the kernel version.<br/>

Eventually if the kernel of Trunk has been updated, you need to find the same config. file (but new, for example: <code>config-3.8</code>) and modify it in accordance with this patch.</em>
</p>

<p>
The integration of the required modules into the kernel, allows us to use  detected SD-card on one level with NOR flash memory. For example: we can mount root-fs at kernel level by setting: <code>CONFIG_CMDLINE=&quot;rootfstype=squashfs,jffs2,ext3 noinitrd root=/dev/mmcblk0p1 rootwait&quot;</code><br/>

</p>

<p>
<br/>

</p>

</div>

<h3 class="sectionedit16" id="testing">Testing</h3>
<div class="level3">

</div>

<h5 id="ar71xx_speed_testing_spi01">(AR71xx) Speed testing spi0.1:</h5>
<div class="level5">

<p>
~ the same as AR724x tests
</p>

</div>

<h5 id="ar724x_speed_testing_spi01">(AR724x) Speed testing spi0.1:</h5>
<div class="level5">

<p>
Read/write speed by using utility <strong>coreutils-dd</strong>:
<pre class="code">root@OpenWrt:~# /usr/bin/dd count=14 bs=1M if=/dev/mmcblk0p1 of=/dev/null
14+0 records in
14+0 records out
14680064 bytes (15 MB) copied, 20.9663 s, 700 kB/s
root@OpenWrt:~# /usr/bin/dd count=14 bs=1M if=/dev/zero of=/dev/mmcblk0p1
14+0 records in
14+0 records out
14680064 bytes (15 MB) copied, 25.2994 s, 580 kB/s
root@OpenWrt:~#</pre>

</p>

<p>
Result <strong>hdparm</strong>:
<pre class="code">root@OpenWrt:~# hdparm -Tt /dev/mmcblk0p1

/dev/mmcblk0p1:
 Timing cached reads:     2 MB in  2.96 seconds = 691.37 kB/sec
 Timing buffered disk reads:   2 MB in  3.05 seconds = 670.43 kB/sec
root@OpenWrt:~#</pre>

</p>

</div>

<h5 id="cpu_load_during_readwrite_process">CPU load during read/write process:</h5>
<div class="level5">

<pre class="code">
root@OpenWrt:~# top
Mem: 28224K used, 1120K free, 0K shrd, 5784K buff, 5592K cached
CPU:   0% usr  <font color="red">99% sys</font>   0% nic   0% idle   0% io   0% irq   0% sirq
Load average: 1.21 0.88 0.60 2/60 28540
  PID  PPID USER     STAT   VSZ %VSZ %CPU COMMAND
 2230     2 root     RW       0   0%  55% [kworker/u:2]
 2180     2 root     SW       0   0%  36% [kworker/u:0]
  559     2 root     RW       0   0%   6% [mmcqd/0]
...
</pre>

<p>
<strong>Conclusion:</strong> operations read/write speed via [ath79-spi↔spi-bitbang↔mmc_spi], directly depends on the frequency of the processor, because is used <a href="http://en.wikipedia.org/wiki/Bit-banging" class="interwiki iw_wp" title="http://en.wikipedia.org/wiki/Bit-banging">Bit-banging</a> method to read/write the word.
</p>

</div>

<h5 id="ar933x_speed_testing_spi01">(AR933x) Speed testing spi0.1:</h5>
<div class="level5">

<p>
<img src="../../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> TODO
</p>

</div>

<h5 id="ar934x_speed_testing_spi01">(AR934x) Speed testing spi0.1:</h5>
<div class="level5">

<p>
<img src="../../../lib/images/smileys/fixme.gif" class="icon" alt="FIXME" /> TODO
</p>

</div>

<h5 id="access_to_spi00_and_spi01_at_the_one_time">Access to spi0.0 and spi0.1 at the one time:</h5>
<div class="level5">

<p>
Here it is necessary to specify method of performing the test. <br/>

We send two parallel commands(operations) read\write command with the division operator <code>&amp;</code> (execute the console command in the background). <br/>

</p>

<p>
Result next: while reading or writing spi0.0 and spi0.1 at the same time (the process does not matter), priority given to spi0.1 bus, i.e. until the end of read/write operation on the spi0.1 bus - on the spi0.0 bus will not begin the requested operation, all operations occurs as a priority and not a bug.
</p>

</div>

<h5 id="power">Power:</h5>
<div class="level5">
<div class="table sectionedit17"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Operation </th><th class="col1"> Probe </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0"> Idle </td><td class="col1 centeralign">  ~1mA  </td>
	</tr>
	<tr class="row2">
		<td class="col0"> Read data </td><td class="col1 centeralign">  ~18mA  </td>
	</tr>
	<tr class="row3">
		<td class="col0"> Write data </td><td class="col1 centeralign">  ~23mA  </td>
	</tr>
</table></div>

</div>

<h3 class="sectionedit18" id="logs">Logs</h3>
<div class="level3">

</div>

<h5 id="log_with_loading_and_initializing_sd-card">Log with loading and initializing SD-card:</h5>
<div class="level5">

<pre class="code">
...
<b><font size=4>[    0.730000] ath79-spi ath79-spi: master is unqueued, this is deprecated</font></b>
[    0.740000] m25p80 spi0.0: found en25f32, expected m25p80
[    0.750000] m25p80 spi0.0: en25f32 (4096 Kbytes)
[    0.750000] 5 tp-link partitions found on MTD device spi0.0
[    0.760000] Creating 5 MTD partitions on "spi0.0":
[    0.760000] 0x000000000000-0x000000020000 : "u-boot"
[    0.770000] 0x000000020000-0x00000013de00 : "kernel"
[    0.770000] mtd: partition "kernel" must either start or end on erase block boundary or be smaller than an erase block -- forcing read-only
[    0.790000] 0x00000013de00-0x0000003f0000 : "rootfs"
[    0.790000] mtd: partition "rootfs" must either start or end on erase block boundary or be smaller than an erase block -- forcing read-only
[    0.810000] mtd: partition "rootfs" set to be root filesystem
[    0.810000] mtd: partition "rootfs_data" created automatically, ofs=370000, len=80000
[    0.820000] 0x000000370000-0x0000003f0000 : "rootfs_data"
[    0.830000] 0x0000003f0000-0x000000400000 : "art"
[    0.840000] 0x000000020000-0x0000003f0000 : "firmware"
[    0.860000] libphy: ag71xx_mdio: probed
[    0.860000] eth0: Atheros AG71xx at 0xba000000, irq 5, mode:GMII
[    1.420000] eth0: Found an AR7240/AR9330 built-in switch
[    2.450000] eth1: Atheros AG71xx at 0xb9000000, irq 4, mode:MII
[    3.000000] ag71xx ag71xx.0 eth1: connected to PHY at ag71xx-mdio.1:04 [uid=004dd041, driver=Generic PHY]
<b><font size=4>[    3.050000] mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff</font></b>
[    3.060000] TCP: cubic registered
[    3.060000] NET: Registered protocol family 17
[    3.070000] 8021q: 802.1Q VLAN Support v1.8
[    3.080000] VFS: Mounted root (squashfs filesystem) readonly on device 31:2.
[    3.090000] Freeing unused kernel memory: 268k freed
<b><font size=4>[    3.310000] mmc0: host does not support reading read-only switch. assuming write-enable.
[    3.320000] mmc0: new SD card on SPI
[    3.480000] mmcblk0: mmc0:0000 00000 1.90 GiB
[    3.490000]  mmcblk0: p1</font></b>
...
</pre>

</div>

<h5 id="error_type_in_the_case_that_system_has_not_detected_the_sd-card">Error type in the case that system has NOT detected the SD-card:</h5>
<div class="level5">

<p>
<pre class="code">...
[    6.070000] mmc_spi spi0.1: SD/MMC host mmc0, no DMA, no WP, no poweroff
...
[    8.710000] mmc0: error -22 whilst initialising SD card
...
[   10.710000] mmc0: error -22 whilst initialising MMC card
...</pre>

</p>

</div>

<h5 id="after_detecting_the_sd-card_we_can_find_partitions">After detecting the SD-card we can find partitions:</h5>
<div class="level5">

<pre class="code">
root@OpenWrt:~# ls /dev/mmc*
<font color="magenta">/dev/mmcblk0    /dev/mmcblk0p1</font>
root@OpenWrt:~#
</pre>

</div>

<h5 id="debug_info">Debug info:</h5>
<div class="level5">

<p>
<pre class="code">root@OpenWrt:~# cat /sys/kernel/debug/mmc0/ios
clock:          25000000 Hz
vdd:            20 (3.2 ~ 3.3 V)
bus mode:       2 (push-pull)
chip select:    1 (active high)
power mode:     2 (on)
bus width:      0 (1 bits)
timing spec:    0 (legacy)
signal voltage: 1 (3.30 V)
root@OpenWrt:~#</pre>

</p>

</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>toh/tp-link/tl-mr3420/deep.mmc.hack.txt</bdi> · Last modified: 2014/10/25 01:11 by <bdi>dioptimizer</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=edit"  class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3420/deep.mmc.hack?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="deep.mmc.hack#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img src="../../../lib/images/license/button/cc-by-nc-sa.png" alt="CC Attribution-Noncommercial-Share Alike 3.0 Unported" /></a>        <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../../lib/tpl/openwrt/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="../../../lib/tpl/openwrt/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../../lib/tpl/openwrt/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../../lib/tpl/openwrt/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../../lib/tpl/openwrt/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="http://wiki.openwrt.org/lib/exe/indexer.php?id=toh%3Atp-link%3Atl-mr3420%3Adeep.mmc.hack&amp;1432279611" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if ( lte IE 7 | IE 8 ) ]></div><![endif]-->
</body>
</html>
