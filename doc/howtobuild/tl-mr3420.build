<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>TP-Link TL-MR3420 &amp; TL-MR3220 Howtobuild [OpenWrt Wiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="doc,howtobuild,tl-mr3420.build"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="OpenWrt Wiki"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="tl-mr3420.build?do=index" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Recent changes" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="../../feed.php?mode=list&amp;ns=doc:howtobuild"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/doc/howtobuild/tl-mr3420.build"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../../_export/raw/doc/howtobuild/tl-mr3420.build"/>
<link rel="canonical" href="tl-mr3420.build"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php?t=openwrt&amp;tseed=6f44f363dc87908d905dc56ff3acbfc4"/>
<script type="text/javascript">/*<![CDATA[*/var NS='doc:howtobuild';var JSINFO = {"id":"doc:howtobuild:tl-mr3420.build","namespace":"doc:howtobuild"};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php?tseed=6f44f363dc87908d905dc56ff3acbfc4"></script>
<script type="text/javascript" charset="utf-8">/*<![CDATA[*/jQuery(function(){
	for ( i=0; i < document.forms.length; i++ ) {
		if (document.forms[i].method == 'post') {
			var myElement = document.createElement('input');
			myElement.setAttribute('type', 'hidden');
			myElement.name = 'bb2_screener_';
			myElement.value = '1432265698 166.182.3.62';
			document.forms[i].appendChild(myElement);
		}
	}
});
/*!]]>*/</script>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../lib/tpl/openwrt/images/favicon.ico" />
<link rel="apple-touch-icon" href="../../lib/tpl/openwrt/images/apple-touch-icon.png" />
    </head>

<body>
    <!--[if lte IE 7 ]><div id="IE7"><![endif]--><!--[if IE 8 ]><div id="IE8"><![endif]-->
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_openwrt     ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="tl-mr3420.build#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="../../start"  accesskey="h" title="[H]"><img src="../../lib/tpl/openwrt/images/logo.png" width="386" height="98" alt="" /> <span>OpenWrt Wiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="tl-mr3420.build?do=register"  class="action register" rel="nofollow" title="Register">Register</a></li><li><a href="tl-mr3420.build?do=login&amp;sectok=382740b13d95f946eed36caa57076b4a"  class="action login" rel="nofollow" title="Login">Login</a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="../../start" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>            <div class="mobileTools">
                <form action="../../doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="doc:howtobuild:tl-mr3420.build" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Show pagesource</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="login">Login</option><option value="register">Register</option></optgroup></select><input type="submit" value="&gt;" /></div></form>            </div>
            <ul>
                <li><a href="tl-mr3420.build?do=recent"  class="action recent" accesskey="r" rel="nofollow" title="Recent changes [R]">Recent changes</a></li><li><a href="tl-mr3420.build?do=media&amp;ns=doc%253Ahowtobuild"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a></li><li><a href="tl-mr3420.build?do=index"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                            <div class="youarehere"><span class="bchead">You are here: </span><span class="home"><bdi><a href="../../start" class="wikilink1" title="start">OpenWrt Wiki</a></bdi></span> » <bdi><a href="../start" class="wikilink1" title="doc:start">Documentation</a></bdi> » <bdi><a href="start" class="wikilink1" title="doc:howtobuild:start">如何编译法</a></bdi> » <bdi><span class="curid"><a href="tl-mr3420.build" class="wikilink1" title="doc:howtobuild:tl-mr3420.build">TP-Link TL-MR3420 &amp; TL-MR3220 Howtobuild</a></span></bdi></div>
                                    <div class="plugin_multilingual">
        <ul>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/cz/doc/howtobuild/tl-mr3420.build" class="media" title="cz:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=aff589&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fcz.gif" class="media" title="Čeština (Czech)" alt="Čeština (Czech)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/de/doc/howtobuild/tl-mr3420.build" class="media" title="de:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=e24010&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fde.gif" class="media" title="Deutsch (German)" alt="Deutsch (German)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <span class="curid"><a href="tl-mr3420.build" class="media" title="doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=2a37ae&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fgb.gif" class="media" title="English" alt="English" /></a></span>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/es/doc/howtobuild/tl-mr3420.build" class="media" title="es:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=46c004&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fmx.gif" class="media" title="Español (Spanish, Mexico)" alt="Español (Spanish, Mexico)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/fr/doc/howtobuild/tl-mr3420.build" class="media" title="fr:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=a5beba&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ffr.gif" class="media" title="Français (French)" alt="Français (French)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/hu/doc/howtobuild/tl-mr3420.build" class="media" title="hu:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=6b5470&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fhu.gif" class="media" title="Magyar (Hungarian)" alt="Magyar (Hungarian)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/jp/doc/howtobuild/tl-mr3420.build" class="media" title="jp:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f999fc&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fjp.gif" class="media" title="日本語 (Japanese)" alt="日本語 (Japanese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pl/doc/howtobuild/tl-mr3420.build" class="media" title="pl:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=c805c0&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fpl.gif" class="media" title="Poliski (Polish)" alt="Poliski (Polish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/pt-br/doc/howtobuild/tl-mr3420.build" class="media" title="pt-br:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=13127d&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fbr.gif" class="media" title="Português brasileiro (Portuguese, Brasil)" alt="Português brasileiro (Portuguese, Brasil)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/ru/doc/howtobuild/tl-mr3420.build" class="media" title="ru:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=66ab5e&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fru.gif" class="media" title="Русский (Russsian)" alt="Русский (Russsian)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/tr/doc/howtobuild/tl-mr3420.build" class="media" title="tr:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=f4beed&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Ftr.gif" class="media" title="Tϋrkçe (Turkish)" alt="Tϋrkçe (Turkish)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-cn/doc/howtobuild/tl-mr3420.build" class="media" title="zh-cn:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=93625a&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-cn.gif" class="media" title="官話/官话 (Chinese)" alt="官話/官话 (Chinese)" /></a>
              </div>
            </div>
          </li>
          <li>
            <div class="li">
              <div class="flag_not_exists">
                <a href="http://wiki.openwrt.org/zh-tw/doc/howtobuild/tl-mr3420.build" class="media" title="zh-tw:doc:howtobuild:tl-mr3420.build"><img src="../../lib/exe/fetch.php?cache=&amp;tok=b56198&amp;media=http%253A%252F%252Fwiki.openwrt.org%252Flib%252Fplugins%252Fmultilingual%252Fflags%252Fzh-tw.gif" class="media" title="臺灣華語 (Taiwanese)" alt="臺灣華語 (Taiwanese)" /></a>
              </div>
            </div>
          </li>
        </ul>
      </div>
        </div>
    
    
    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">

                <div class="pageId"><span>doc:howtobuild:tl-mr3420.build</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="tl-mr3420.build#tp-link_tl-mr3420first_round">TP-Link TL-MR3420: First round</a></div></li>
<li class="level1"><div class="li"><a href="tl-mr3420.build#start_over">Start over</a></div></li>
<li class="level1"><div class="li"><a href="tl-mr3420.build#sync_with_current_snapshot">Sync with current snapshot</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="tl-mr3420.build#manual">Manual</a></div></li>
<li class="level2"><div class="li"><a href="tl-mr3420.build#automatic">Automatic</a></div></li>
<li class="level2"><div class="li"><a href="tl-mr3420.build#kmod_compatibility_hack">kmod compatibility hack</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="tl-mr3420.build#every_day_standard_compile">Every day standard compile</a></div></li>
<li class="level1"><div class="li"><a href="tl-mr3420.build#tp-link_tl-mr3220">TP-Link TL-MR3220</a></div>
<ul class="toc">
<li class="clear">
<ul class="toc">
<li class="level3"><div class="li"><a href="tl-mr3420.build#step_by_step">Step by step</a></div></li>
<li class="level3"><div class="li"><a href="tl-mr3420.build#configuration_by_default">Configuration by default</a></div></li>
<li class="level3"><div class="li"><a href="tl-mr3420.build#local_server">Local server</a></div></li>
<li class="level3"><div class="li"><a href="tl-mr3420.build#at_work">At Work</a></div></li>
<li class="level3"><div class="li"><a href="tl-mr3420.build#notes">Notes</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="tp-link_tl-mr3420_tl-mr3220_howtobuild">TP-Link TL-MR3420 &amp; TL-MR3220 Howtobuild</h1>
<div class="level1">

<p>
<a href="../../toh/tp-link/tl-mr3220" class="wikilink1" title="toh:tp-link:tl-mr3420">TL-MR3420</a>
</p>

<p>
TODO<a href="../../_detail/meta/48px-construction.svg.png?id=doc%253Ahowtobuild%253Atl-mr3420.build" class="media" title="meta:48px-construction.svg.png"><img src="../../_media/meta/48px-construction.svg.png" class="media" title="TODO" alt="TODO" /></a>
</p>

</div>

<h2 class="sectionedit2" id="tp-link_tl-mr3420first_round">TP-Link TL-MR3420: First round</h2>
<div class="level2">

<p>
This only have to be done once in a lifetime.
</p>

<p>
<pre class="code bash"><span class="re2">r</span>=<span class="nu0">28535</span>
<span class="kw3">cd</span> ~
<span class="kw2">mkdir</span> <span class="re5">-p</span> build<span class="sy0">/</span>openwrt
<span class="kw2">mkdir</span> build<span class="sy0">/</span>dl
<span class="kw2">mkdir</span> <span class="re5">-p</span> build<span class="sy0">/</span>files<span class="sy0">/</span>ar71xx
<span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt
<span class="kw2">svn co</span> <span class="re5">-r</span> <span class="re1">$r</span> svn:<span class="sy0">//</span>svn.openwrt.org<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk<span class="sy0">/</span>
<span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk
<span class="kw2">ln</span> <span class="re5">-sf</span> ..<span class="sy0">/</span>..<span class="sy0">/</span>dl
<span class="kw2">ln</span> <span class="re5">-sfn</span> ..<span class="sy0">/</span>..<span class="sy0">/</span>files<span class="sy0">/</span>ar71xx files
<span class="kw2">cp</span> <span class="re5">-p</span> scripts<span class="sy0">/</span>feeds scripts<span class="sy0">/</span>feeds.sed</pre>

</p>

</div>

<h2 class="sectionedit3" id="start_over">Start over</h2>
<div class="level2">

<p>
When all else fail.
</p>

<p>
<pre class="code bash"><span class="re2">r</span>=<span class="nu0">28535</span>
<span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk
<span class="kw2">rm</span> <span class="re5">-fr</span> staging_dir build_dir bin broken_packages
<span class="kw2">make</span> distclean
<span class="kw2">ln</span> <span class="re5">-sf</span> ..<span class="sy0">/</span>..<span class="sy0">/</span>dl
<span class="kw2">ln</span> <span class="re5">-sfn</span> ..<span class="sy0">/</span>..<span class="sy0">/</span>files<span class="sy0">/</span>ar71xx files
<span class="kw2">svn up</span> <span class="re5">-r</span> <span class="re1">$r</span></pre>

</p>

</div>

<h2 class="sectionedit4" id="sync_with_current_snapshot">Sync with current snapshot</h2>
<div class="level2">

<p>
Lazy people don&#039;t like to spend hours compiling packages you will never use. Instead, download them all and compile your image in a few minutes.
</p>

<p>
This is where the value of &quot;r&quot; come from.
</p>

<p>
Current snapshot last for 24 hs, lately. Sync has not much sense, then.
</p>

</div>

<h3 class="sectionedit5" id="manual">Manual</h3>
<div class="level3">

<p>
Browse to <a href="http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/" class="urlextern" title="http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/"  rel="nofollow">http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/</a> and look the value of base-files_??-<strong>r?????</strong>_ar71xx.ipk
<pre class="code bash"><span class="re2">r</span>=<span class="nu0">29484</span></pre>

(At the time of writing this guide)
</p>

</div>

<h3 class="sectionedit6" id="automatic">Automatic</h3>
<div class="level3">

<p>
<pre class="code bash"><span class="re2">baseurl</span>=http:<span class="sy0">//</span>downloads.openwrt.org<span class="sy0">/</span>snapshots<span class="sy0">/</span>trunk<span class="sy0">/</span>
<span class="re2">platform</span>=ar71xx
<span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk
<span class="kw2">wget</span> <span class="re5">-N</span> <span class="re1">$baseurl</span><span class="re1">$platform</span><span class="sy0">/</span>packages<span class="sy0">/</span>Packages.gz
<span class="re2">r</span>=$<span class="br0">&#40;</span><span class="kw2">zgrep</span> base-files_ Packages.gz <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st_h">'s/^.*-r\(.*\)_ar71xx.ipk/\1/'</span><span class="br0">&#41;</span></pre>

</p>

</div>

<h3 class="sectionedit7" id="kmod_compatibility_hack">kmod compatibility hack</h3>
<div class="level3">

<p>
After <a href="https://dev.openwrt.org/changeset/29686" class="urlextern" title="https://dev.openwrt.org/changeset/29686"  rel="nofollow">r29686</a> opkg spit all kmod-* packages not compiled by yourself. There should be a good reason for that, but I take the risk.
<pre class="code bash"><span class="kw2">grep</span> vermagic include<span class="sy0">/</span>kernel-defaults.mk
	$<span class="br0">&#40;</span>SH_FUNC<span class="br0">&#41;</span> <span class="kw2">grep</span> <span class="st_h">'=[ym]'</span> $<span class="br0">&#40;</span>LINUX_DIR<span class="br0">&#41;</span><span class="sy0">/</span>.config <span class="sy0">|</span> <span class="re2">LC_ALL</span>=C <span class="kw2">sort</span> <span class="sy0">|</span> md5s <span class="sy0">&gt;</span> $<span class="br0">&#40;</span>LINUX_DIR<span class="br0">&#41;</span><span class="sy0">/</span>.vermagic</pre>

That line creates the &quot;incompatibility&quot;
<pre class="code bash"><span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk
<span class="kw2">zgrep</span> <span class="re5">-m</span> <span class="nu0">1</span> <span class="st0">&quot;Depends: kernel (=.*)$&quot;</span> Packages.gz <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st_h">'s/.*-\(.*\))/\1/'</span> <span class="sy0">&gt;</span> .vermagic
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st_h">'s/^\(.\).*vermagic$/\1cp $(TOPDIR)\/.vermagic $(LINUX_DIR)\/.vermagic/'</span> include<span class="sy0">/</span>kernel-defaults.mk</pre>

Now, that line creates the &quot;compatibility&quot;
<pre class="code bash"><span class="kw2">grep</span> vermagic include<span class="sy0">/</span>kernel-defaults.mk
	<span class="kw2">cp</span> $<span class="br0">&#40;</span>TOPDIR<span class="br0">&#41;</span><span class="sy0">/</span>.vermagic $<span class="br0">&#40;</span>LINUX_DIR<span class="br0">&#41;</span><span class="sy0">/</span>.vermagic</pre>

Use at your own risk.
</p>

</div>

<h2 class="sectionedit8" id="every_day_standard_compile">Every day standard compile</h2>
<div class="level2">

<p>
<pre class="code bash"><span class="re2">r</span>=<span class="nu0">29484</span>
<span class="kw3">cd</span> ~<span class="sy0">/</span>build<span class="sy0">/</span>openwrt<span class="sy0">/</span>trunk
<span class="kw2">svn up</span> <span class="re5">-r</span> <span class="re1">$r</span>
.<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds update <span class="re5">-a</span> <span class="sy0">|</span> <span class="kw2">grep</span> revisi
<span class="co0"># packages 28574 xwrt 4986 luci 7776</span>
<span class="re2">luci</span>=$<span class="br0">&#40;</span><span class="kw2">zgrep</span> luci_ Packages.gz <span class="sy0">|</span> <span class="kw2">sed</span> <span class="re5">-e</span> <span class="st_h">'s/^.*svn\([0-9]*\).*/\1/'</span><span class="br0">&#41;</span>
<span class="co0"># luci=7771</span>
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st0">&quot;s/<span class="es1">\&quot;</span>svn update.*<span class="es1">\&quot;</span>,/<span class="es1">\&quot;</span>svn update -r <span class="es2">$r</span><span class="es1">\&quot;</span>,/&quot;</span> .<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds.sed
.<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds.sed update packages
<span class="kw2">sed</span> <span class="re5">-i</span> <span class="re5">-e</span> <span class="st0">&quot;s/<span class="es1">\&quot;</span>svn update.*<span class="es1">\&quot;</span>,/<span class="es1">\&quot;</span>svn update -r <span class="es2">$luci</span><span class="es1">\&quot;</span>,/&quot;</span> .<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds.sed
.<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds.sed update luci
.<span class="sy0">/</span>scripts<span class="sy0">/</span>feeds <span class="kw2">install</span> <span class="re5">-a</span>
<span class="kw3">echo</span> <span class="re2">CONFIG_TARGET_ar71xx</span>=y <span class="sy0">&gt;</span> .config
<span class="kw2">make</span> defconfig
<span class="kw2">make</span> download
<span class="kw2">make</span> world</pre>

If vanilla build exit with error, current trunk is broken, checkout again tomorrow. Else, is time to add some packages: <sup><a href="tl-mr3420.build#fn__1" id="fnt__1" class="fn_top">1)</a></sup>
</p>

<p>
<pre class="code bash"><span class="kw3">echo</span> <span class="st0">&quot;CONFIG_TARGET_ar71xx=y
# CONFIG_TARGET_ar71xx_generic_Default is not set
CONFIG_TARGET_ar71xx_generic_TLMR3220=y
CONFIG_ATH_USER_REGD=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-app-qos=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-input-gpio-keys-polled=y&quot;</span> <span class="sy0">&gt;</span> .config
<span class="kw2">make</span> defconfig
<span class="kw2">make</span> download
<span class="kw2">make</span> world
<span class="kw2">ls</span> <span class="re5">-lat</span> bin<span class="sy0">/</span>ar71xx<span class="sy0">/</span></pre>

</p>

</div>

<h2 class="sectionedit9" id="tp-link_tl-mr3220">TP-Link TL-MR3220</h2>
<div class="level2">

</div>

<h4 id="step_by_step">Step by step</h4>
<div class="level4">

<p>
We have very few differences with MR3420, however I go step by step.
</p>

<p>
Visit <a href="../howto/obtain.firmware.compile" class="wikilink1" title="doc:howto:build">build</a> and <a href="../howto/buildroot.exigence" class="wikilink1" title="doc:howto:buildroot.exigence">buildroot.exigence</a> for a comprehensive explanation about everything you need.
</p>

<p>
For MR3220 need to use Development Sources, select a place for buildroot and do:
</p>
<pre class="code"> svn checkout svn://svn.openwrt.org/openwrt/trunk/
 cd trunk
 make menuconfig</pre>

<p>
If success (check <a href="../howto/buildroot.exigence" class="wikilink1" title="doc:howto:buildroot.exigence">buildroot.exigence</a> if any error) then select:
</p>
<pre class="code">Target System (Atheros AR71xx/AR7240/AR913x/AR934x)  ---&gt; 
Target Profile (TP-LINK TL-MR3220)  ---&gt;</pre>

<p>
Exit and save changes. If you like default configurations (little, similar that snapshots but without extra modules to compile) do:
</p>
<pre class="code">make defconfig</pre>

<p>
But it&#039;s very basic. if you like add modem-3g support<sup><a href="tl-mr3420.build#fn__2" id="fnt__2" class="fn_top">2)</a></sup> or LuCi (i.e.) you need <a href="../devel/feeds" class="wikilink1" title="doc:devel:feeds">feeds</a>:
</p>
<pre class="code">./scripts/feeds update -a</pre>

<p>
and install all feeds (not recommended but look for PACKAGE_usb-modeswitch on submenu &quot;Utilities&quot;…) <sup><a href="tl-mr3420.build#fn__3" id="fnt__3" class="fn_top">3)</a></sup>
</p>
<pre class="code">./scripts/feeds install -a</pre>

<p>
or select by name:
</p>
<pre class="code">./scripts/feeds install -a -p luci</pre>

<p>
With a new &quot;make menuconfig&quot; you see a lot of new options. Select all modules that you like, but only those packages you want to use (built in -*- or not -M-), and note that each package selected, it automatically selects proper dependencies. <strong>No need to worry about those do not select, because those are not going to download and compile.</strong>
</p>
<div class="table sectionedit10"><table class="inline">
	<tr class="row0">
		<td class="col0"><img src="../../_media/meta/icons/tango/48px-dialog-warning.svg.png?w=24&amp;tok=0fc4e5" class="medialeft" title="Stability warning" alt="Stability warning" width="24" /> </td><td class="col1"> In principle not a good idea to deselect a package, to avoid compilation, but download it later from the snapshots: that may mean we have a &quot;kernel panic&quot; and a lot of runtime errors, since the kernel is not prepared to work with it. If you want to add more features and packages. then recompile to add support. Any generic image from snapshots have all packages selected as modules. </td>
	</tr>
</table></div>

<p>
it only remains to compile (need internet access, you can use &quot;make download&quot; before to prepare the compilation):
</p>
<pre class="code">make</pre>

<p>
or
</p>
<pre class="code">make V=99</pre>

<p>
If success you can find a trunk/bin/ar71xx with factory and sysupgrade images, along with the packages you have selected to compile on trunk/bin/ar71xx/packages
</p>

</div>

<h4 id="configuration_by_default">Configuration by default</h4>
<div class="level4">

<p>
If you have a compatible backup of configuration (such as those through LuCI) you can enter it in your image, so as simple as creating a folder called trunk/files and unzip the contents there, for example the file trunk/files/etc/config/network with the correct settings for 3g modem. <sup><a href="tl-mr3420.build#fn__4" id="fnt__4" class="fn_top">4)</a></sup>
</p>

</div>

<h4 id="local_server">Local server</h4>
<div class="level4">

<p>
In case of conflicts between versions if the installed version is older than snapshots (or may not yet have an internet connection configured correctly), a way to fix is have a local server with our compiled packages: on your computer copy trunk/bin/ar71xx/packages over /srv/ftp/packages (vsftpd default with anonymous enabled), and on router edit first line on /etc/opkg.conf:
</p>
<pre class="code"> src/gz snapshots ftp://192.168.1.100/packages</pre>

<p>
A simple &quot;opkg update&quot; and you will see that it work.
</p>

</div>

<h4 id="at_work">At Work</h4>
<div class="level4">

<p>
Due to the recent addition to OpenWrt, it is likely that this will improve support for this router, so we can take a look at the scripts to update the code in the first part of this howto about MR3420. However, basic command, before run <em>make</em> over trunk directory, is:
</p>
<pre class="code">svn update
./scripts/feeds update -a</pre>

<p>
And remember do a previous backup of your <em>.config</em>, it&#039;s easy to be overwritten in the process. But it may not be advisable to recover the backup directly, because it may have added new options or packages. An easy way to see the differences is through diff command.
</p>

</div>

<h4 id="notes">Notes</h4>
<div class="level4">
<ol>
<li class="level1"><div class="li"> For add support for wireless channels 12-13 (with legal use out of US) try to add CONFIG_ATH_USER_REGD=y on <em>.config</em> (but check <a href="https://dev.openwrt.org/ticket/10496" class="urlextern" title="https://dev.openwrt.org/ticket/10496"  rel="nofollow">#10496</a> if it don&#039;t work). Also, you need install <em>kmod-wprobe</em>.</div>
</li>
<li class="level1"><div class="li"> In case squashfs image that does not appear or is not updated, after compiling, it means the final size exceeded the limit of 3.8 megabytes. We have to do without some packages, just changing them as modules (marked &quot;m&quot;) and install them later with opkq if we have space with a <a href="../howto/extroot" class="wikilink1" title="doc:howto:extroot">extrootfs</a> (but keep in mind that any kermel module needed in the boot should not stay in the extroot).</div>
</li>
<li class="level1"><div class="li"> jffs2 errors from compiled images when the sysupgrade image file size is bigger than 3.585kB ( 3,5 MiB or 3670020 bytes ) <a href="https://dev.openwrt.org/ticket/10719" class="urlextern" title="https://dev.openwrt.org/ticket/10719"  rel="nofollow">#10719</a> (if overlay no init is difficult make a working ext-overlay)</div>
</li>
</ol>

</div>
<div class="footnotes">
<div class="fn"><sup><a href="tl-mr3420.build#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
 CONFIG_PACKAGE_block-extroot=y is ignored on trunk, just CONFIG_PACKAGE_block-mount=y. As of <a href="https://dev.openwrt.org/changeset/26314/trunk" class="urlextern" title="https://dev.openwrt.org/changeset/26314/trunk"  rel="nofollow">r26314</a> <code>block-extroot</code> and <code>block-hotplug</code> have been merged with <strong><code>block-mount</code></strong>. </div>
<div class="fn"><sup><a href="tl-mr3420.build#fnt__2" id="fn__2" class="fn_bot">2)</a></sup> 
 TODO: Detailed reference of feeds USB and 3g support </div>
<div class="fn"><sup><a href="tl-mr3420.build#fnt__3" id="fn__3" class="fn_bot">3)</a></sup> 
 Also we can try with <em>./scripts/feeds update packages</em> and <em>./scripts/feeds install packages</em> </div>
<div class="fn"><sup><a href="tl-mr3420.build#fnt__4" id="fn__4" class="fn_bot">4)</a></sup> 
 ISP number can be fixed on trunk/package/comgt/files/3g.chat </div>
</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>doc/howtobuild/tl-mr3420.build.txt</bdi> · Last modified: 2012/07/11 09:08 by <bdi>nilfred</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="tl-mr3420.build?do=edit"  class="action source" accesskey="v" rel="nofollow" title="Show pagesource [V]"><span>Show pagesource</span></a></li><li><a href="tl-mr3420.build?do=revisions"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="tl-mr3420.build?do=backlink"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="tl-mr3420.build#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license"><img src="../../lib/images/license/button/cc-by-nc-sa.png" alt="CC Attribution-Noncommercial-Share Alike 3.0 Unported" /></a>        <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../lib/tpl/openwrt/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://www.php.net" title="Powered by PHP" ><img
            src="../../lib/tpl/openwrt/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../lib/tpl/openwrt/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../lib/tpl/openwrt/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../lib/tpl/openwrt/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="../../lib/exe/indexer.php?id=doc%253Ahowtobuild%253Atl-mr3420.build&amp;1432265698" width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div>    <!--[if ( lte IE 7 | IE 8 ) ]></div><![endif]-->
</body>
</html>
